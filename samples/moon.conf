# ============================================================================
# Moon - Dynamic Headless Engine Configuration
# ============================================================================
#
# This is the comprehensive, spec-compliant configuration file for Moon.
# By default, only essential options are enabled. All advanced and optional
# options are included but commented out.
#
# SPEC-COMPLIANT: This file strictly follows SPEC.md and SPEC_AUTH.md
#
# Quick Start:
# 1. Copy this file to /etc/moon.conf
# 2. Change the JWT secret (see jwt.secret below)
# 3. Update bootstrap admin password (see auth.bootstrap_admin below)
# 4. Uncomment and configure optional features as needed
# 5. Start Moon with: moon daemon --config /etc/moon.conf
#
# Documentation:
# - SPEC.md: Complete system specification
# - SPEC_AUTH.md: Authentication and authorization specification
# - INSTALL.md: Installation and setup instructions
#
# ============================================================================

# ============================================================================
# Server Configuration (REQUIRED)
# ============================================================================
server:
  # HTTP server host address
  # Default: 0.0.0.0 (listens on all network interfaces)
  # Set to 127.0.0.1 to listen only on localhost
  host: "0.0.0.0"
  
  # HTTP server port
  # Default: 6006
  # Valid range: 1-65535
  port: 6006
  
  # URL prefix for all API endpoints
  # Default: "" (empty - no prefix)
  # When set, all endpoints are mounted under this prefix
  # Examples:
  #   - "" (empty): /health, /collections:list, /{collection}:list
  #   - "/api/v1": /api/v1/health, /api/v1/collections:list
  #   - "/moon/api": /moon/api/health, /moon/api/collections:list
  # Note: Leading slash is required (automatically added if missing)
  prefix: ""

# ============================================================================
# Database Configuration (REQUIRED)
# ============================================================================
database:
  # Database connection type
  # Supported values: sqlite, postgres, mysql
  # Default: sqlite
  connection: "sqlite"
  
  # Database file path (for SQLite) or database name (for PostgreSQL/MySQL)
  # Default: /opt/moon/sqlite.db
  # Examples:
  #   - SQLite: /opt/moon/sqlite.db
  #   - PostgreSQL: mydbname
  #   - MySQL: mydbname
  database: "/opt/moon/sqlite.db"
  
  # Database user (for PostgreSQL/MySQL only)
  # Default: "" (empty for SQLite)
  # user: ""
  
  # Database password (for PostgreSQL/MySQL only)
  # Default: "" (empty for SQLite)
  # password: ""
  
  # Database host (for PostgreSQL/MySQL only)
  # Default: 0.0.0.0
  # Examples: localhost, 127.0.0.1, db.example.com
  # host: "0.0.0.0"
  
  # Query timeout in seconds
  # Default: 30
  # Maximum time allowed for a single database query
  # query_timeout: 30
  
  # Slow query threshold in milliseconds
  # Default: 500
  # Queries taking longer than this are logged as warnings
  # slow_query_threshold: 500

# ============================================================================
# Logging Configuration (REQUIRED)
# ============================================================================
logging:
  # Log directory path
  # Default: /var/log/moon
  # Logs will be written to {path}/main.log in daemon mode
  # In console mode, logs are written to stdout/stderr
  path: "/var/log/moon"
  
  # Redact sensitive data in logs
  # Default: true
  # When enabled, sensitive fields are automatically redacted:
  # - password, token, secret, api_key, apikey
  # - authorization, jwt, refresh_token, access_token
  # - client_secret, private_key, credential, auth
  # redact_sensitive: true
  
  # Additional fields to redact (beyond defaults)
  # Default: [] (empty)
  # Example:
  # additional_sensitive_fields:
  #   - "ssn"
  #   - "credit_card"

# ============================================================================
# JWT Authentication Configuration (REQUIRED)
# ============================================================================
jwt:
  # JWT secret key for token signing (REQUIRED)
  # This MUST be set to a secure random string in production
  # Generate a secure secret with: openssl rand -base64 32
  # 
  # SECURITY REQUIREMENTS:
  # - Minimum 32 characters recommended
  # - Use cryptographically random value
  # - Never commit to version control
  # - Rotate periodically (invalidates all existing tokens)
  #
  # Example: "dGhpcyBpcyBhIHNlY3VyZSBzZWNyZXQga2V5"
  secret: "your-secret-key-change-in-production"
  
  # Access token expiration time in seconds
  # Default: 3600 (1 hour)
  # Common values:
  #   - 900 (15 minutes) - High security
  #   - 3600 (1 hour) - Standard
  #   - 86400 (24 hours) - Low security / development
  #
  # Shorter expiry = more secure but more frequent refreshes
  access_expiry: 3600
  
  # Refresh token expiration time in seconds
  # Default: 604800 (7 days)
  # Refresh tokens are single-use and invalidated after each refresh
  # Common values:
  #   - 86400 (1 day) - High security
  #   - 604800 (7 days) - Standard
  #   - 2592000 (30 days) - Long sessions
  refresh_expiry: 604800

# ============================================================================
# API Key Authentication Configuration (Optional)
# ============================================================================
apikey:
  # Enable or disable API key authentication
  # Default: false
  # When enabled, clients can authenticate using X-API-Key header
  # 
  # Use cases:
  # - Machine-to-machine integrations
  # - CI/CD pipelines
  # - Service accounts
  # - Third-party integrations
  enabled: true
  
  # HTTP header name for API key
  # Default: X-API-KEY
  # Clients must send their API key in this header
  # 
  # Example request:
  #   curl -H "X-API-Key: moon_live_abc123..." http://localhost:6006/collections:list
  header: "X-API-Key"

# ============================================================================
# Bootstrap Admin Configuration (First-Time Setup Only)
# ============================================================================
# This section creates an initial admin user on first startup.
#
# ⚠️  SECURITY WARNINGS:
# ⚠️  1. Change the password IMMEDIATELY after first login!
# ⚠️  2. Remove or comment out this section after first startup!
# ⚠️  3. Never commit bootstrap credentials to version control!
#
# On first startup, if no admin users exist in the database, Moon will:
# 1. Check if this section exists in the config
# 2. Create an admin user with these credentials
# 3. Log a warning to change the password
#
# If bootstrap config is absent and no admin exists, Moon will log an error
# and require manual admin creation via direct database access.
auth:
  bootstrap_admin:
    # Admin username (must be unique)
    username: "admin"
    
    # Admin email (must be unique, valid email format)
    email: "admin@example.com"
    
    # Initial password - CHANGE THIS IMMEDIATELY AFTER FIRST LOGIN!
    # Must meet password policy:
    # - Minimum 8 characters
    # - At least one uppercase letter
    # - At least one lowercase letter
    # - At least one number
    password: "moonadmin12#"
  
  # ============================================================================
  # Rate Limiting Configuration (Optional)
  # ============================================================================
  # Rate limits protect against abuse and ensure fair resource usage.
  # All rate limits use a sliding window algorithm.
  #
  # Response headers on all requests:
  # - X-RateLimit-Limit: Maximum requests allowed in window
  # - X-RateLimit-Remaining: Requests remaining in current window
  # - X-RateLimit-Reset: Unix timestamp when limit resets
  #
  # When rate limit exceeded:
  # - Returns HTTP 429 Too Many Requests
  # - Includes Retry-After header with seconds until reset
  rate_limit:
    # Requests per minute for JWT-authenticated users
    # Default: 100
    # Recommended: 50-200 depending on use case
    user_rpm: 100
    
    # Requests per minute for API key-authenticated requests
    # Default: 1000 (higher for machine-to-machine)
    # Recommended: 500-2000 depending on integration needs
    apikey_rpm: 1000
    
    # Maximum failed login attempts per 15 minutes per IP/username
    # Default: 5
    # After exceeding, returns 429 until window expires
    # Protects against brute force attacks
    login_attempts: 5
    
    # Login attempt window in seconds
    # Default: 900 (15 minutes)
    # Window for tracking failed login attempts
    # login_window: 900

# ============================================================================
# Recovery and Consistency Checking Configuration (Optional)
# ============================================================================
# recovery:
#   # Automatically repair consistency issues on startup
#   # Default: true
#   # When true, Moon will:
#   # - Remove orphaned registry entries (registered but table doesn't exist)
#   # - Register or drop orphaned tables based on drop_orphans setting
#   auto_repair: true
#   
#   # Drop orphaned tables (tables without registry entries)
#   # Default: false
#   # When false: Orphaned tables are registered automatically
#   # When true: Orphaned tables are dropped from database
#   # WARNING: Setting to true may result in data loss
#   drop_orphans: false
#   
#   # Timeout for consistency checks in seconds
#   # Default: 5
#   # Prevents startup delays if database is slow/locked
#   check_timeout: 5

# ============================================================================
# CORS Configuration (Optional)
# ============================================================================
# Cross-Origin Resource Sharing (CORS) for browser-based API access
# cors:
#   # Enable CORS support
#   # Default: false (disabled for security)
#   # When enabled, allows browsers to make cross-origin requests
#   enabled: false
#   
#   # Allowed origins (required if enabled)
#   # Default: [] (empty)
#   # Examples:
#   #   - "https://app.example.com"
#   #   - "http://localhost:3000" (development only)
#   allowed_origins:
#     - "https://app.example.com"
#     - "http://localhost:3000"
#   
#   # Allowed HTTP methods
#   # Note: Moon only supports GET, POST, and OPTIONS methods
#   # Default: ["GET", "POST", "OPTIONS"]
#   # allowed_methods:
#   #   - "GET"
#   #   - "POST"
#   #   - "OPTIONS"
#   
#   # Allowed request headers
#   # Default: ["Content-Type", "Authorization", "X-API-Key"]
#   # allowed_headers:
#   #   - "Content-Type"
#   #   - "Authorization"
#   #   - "X-API-Key"
#   
#   # Allow credentials (cookies, auth headers)
#   # Default: true
#   # allow_credentials: true
#   
#   # Preflight cache duration in seconds
#   # Default: 3600 (1 hour)
#   # max_age: 3600

# ============================================================================
# Pagination Configuration (Optional)
# ============================================================================
# Controls default and maximum page sizes for list endpoints
# pagination:
#   # Default number of records returned when no limit is specified
#   # Default: 15
#   # Recommended: 10-50 depending on typical client needs
#   default_page_size: 15
#   
#   # Maximum allowed page size
#   # Default: 200
#   # Clients requesting more than this will receive an error
#   max_page_size: 200

# ============================================================================
# System Limits Configuration (Optional)
# ============================================================================
# Controls maximum counts for collections, columns, and query parameters
# limits:
#   # Maximum number of collections (tables) allowed per server
#   # Default: 1000
#   max_collections: 1000
#   
#   # Maximum columns per collection (including system columns id, ulid)
#   # Default: 100
#   max_columns_per_collection: 100
#   
#   # Maximum filter parameters allowed per request
#   # Default: 20
#   max_filters_per_request: 20
#   
#   # Maximum sort fields allowed per request
#   # Default: 5
#   max_sort_fields_per_request: 5

# ============================================================================
# Configuration Examples for Different Databases
# ============================================================================
#
# SQLite (default):
#   database:
#     connection: "sqlite"
#     database: "/opt/moon/sqlite.db"
#
# PostgreSQL:
#   database:
#     connection: "postgres"
#     database: "moon_db"
#     user: "moon_user"
#     password: "secure_password"
#     host: "localhost"
#
# MySQL:
#   database:
#     connection: "mysql"
#     database: "moon_db"
#     user: "moon_user"
#     password: "secure_password"
#     host: "localhost"

# ============================================================================
# Production Deployment Checklist
# ============================================================================
#
# Security:
# [ ] Generated unique JWT secret (openssl rand -base64 32)
# [ ] Changed bootstrap admin password
# [ ] Removed bootstrap_admin section from config
# [ ] File permissions set (chmod 600 /etc/moon.conf)
# [ ] Using HTTPS via reverse proxy (nginx, caddy, etc.)
#
# Performance:
# [ ] Rate limits tuned for expected traffic
# [ ] Database connection pooling configured (if using Postgres/MySQL)
# [ ] Log rotation configured
#
# Monitoring:
# [ ] Health endpoint monitored (/health)
# [ ] Log aggregation set up
# [ ] Alerts configured for 429/500 errors
