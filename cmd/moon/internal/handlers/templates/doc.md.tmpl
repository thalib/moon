{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}
# Moon API Documentation

**Version:** {{.Version}}  
**Service:** moon

## Table of Contents

- [Overview](#overview)
  - [Authentication](#authentication)
  - [URL Structure](#url-structure)
  - [Available Collections](#available-collections)
- [Response Format](#response-format)
- [Collection Management](#collection-management)
- [API Endpoints](#api-endpoints)
  - [Data Access](#data-access)
  - [Aggregation Operations](#aggregation-operations)
  - [Query Options](#query-options)
    - [Filtering](#filtering)
    - [Sorting](#sorting)
    - [Full-Text Search](#full-text-search)
    - [Field Selection](#field-selection)
    - [Pagination](#pagination)
- [Examples](#examples)

## Overview

Moon is a dynamic headless engine that provides a RESTful API for managing database tables and records without manual migrations. All endpoints follow the AIP-136 custom actions pattern using a colon separator between the resource and action.

### Authentication

{{if or .JWTEnabled .APIKeyEnabled}}This API requires authentication for most endpoints.

{{if .JWTEnabled}}**JWT Authentication:** Include a bearer token in the Authorization header:

```
Authorization: Bearer <your-jwt-token>
```

{{end}}{{if .APIKeyEnabled}}**API Key Authentication:** Include your API key in the {{.APIKeyHeader}} header:

```
{{.APIKeyHeader}}: <your-api-key>
```

{{end}}{{else}}Authentication is currently disabled for this instance.

{{end}}

### URL Structure

**Base URL:** `{{.BaseURL}}`

{{if .Prefix}}
**URL Prefix:** `{{.Prefix}}`

All endpoints are prefixed with `{{.Prefix}}`.
{{end}}

```
{{$ApiURL}}/health
{{$ApiURL}}/collections:list
```

## Response Format

All successful responses return JSON with relevant data.

**Common Status Codes:**

- `200 OK` - Successful GET requests
- `201 Created` - Successful POST requests creating resources
- `400 Bad Request` - Invalid input, missing required field, invalid filter operator
- `404 Not Found` - Collection or record not found
- `409 Conflict` - Collection already exists
- `500 Internal Server Error` - Server error

**Success Responses (201 Created)**

```json
{
  "message": "Collection created successfully",
  "collection": {
    "name": "products",
    "columns": [...]
  }
}
```

**Error Responses**

All errors follow a consistent JSON structure:

```json
{
  "error": "Error message describing what went wrong",
  "code": 400
}
```



## Collection Management

These endpoints manage database tables (collections) and their schemas.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

**List Collections**

```bash
curl -s {{$ApiURL}}/collections:list | jq .
```

**Create a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:create" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "float", "nullable": false},
      {"name": "description", "type": "text", "nullable": true}
    ]
  }'
```

**Get Collections schema**

```bash
curl -s {{$ApiURL}}/collections:get?name=products | jq .
```

**Update a Collection Schema**

```bash
curl -X POST "{{$ApiURL}}/collections:update" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "float", "nullable": false},
      {"name": "description", "type": "text", "nullable": true},
      {"name": "stock", "type": "integer", "nullable": false}
    ]
  }'
```

**Delete a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:destroy" \
  -H "Content-Type: application/json" \
  -d '{"name": "products"}'
```

## API Endpoints

### Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

### Aggregation Operations

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |

#### Query Options

##### Filtering: 

Query: `?column[operator]=value` 

```bash
curl {{$ApiURL}}/{collection}:list?price[gt]=100&category[eq]=electronics
```

**Operators:** `eq`, `ne`, `gt`, `lt`, `gte`, `lte`, `like`, `in`

#### Sorting: 

Query: `?sort={-field1,field2}` 

```bash
curl {{$ApiURL}}/{collection}:list?sort=-price,name
```

Sort by 
- `field` (ascending) 
- `-field` (descending)

#### Full-Text Search:

Query: `?q={search_term}`

Search across all text columns

```bash
curl {{$ApiURL}}/{collection}:list?q=laptop
```

#### Field Selection 

Query: `?fields={field1,field2}`

```bash
curl {{$ApiURL}}/{collection}:list?fields=name,price
```

Return only specific fields (always includes id)

#### Pagination 

Query: `?after={cursor}&limit={limit}`

```bash
curl {{$ApiURL}}/{collection}:list?after=01ARZ3NDEKTSV4RRFFQ69G5FBX&limit=10
```

Response includes `next_cursor` when more results are available.

## Examples

Get started with Moon using these real, working examples for a `products` collection:

### 1. Create a collection

```bash
curl -X POST "{{$ApiURL}}/collections:create" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "float", "nullable": false},
      {"name": "description", "type": "text", "nullable": true}
    ]
  }'
```

### 2. Insert a record

```bash
curl -X POST "{{$ApiURL}}/products:create" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "title": "Wireless Mouse",
      "price": 29.99,
      "description": "Ergonomic wireless mouse"
    }
  }'
```

**Response (201 Created):**

```json
{
  "message": "Record created successfully",
  "data": {
    "id": "01ARZ3NDEKTSV4RRFFQ69G5FBX",
    "title": "Wireless Mouse",
    "price": 29.99,
    "description": "Ergonomic wireless mouse"
  }
}
```

### 3. List records

```bash
curl -s "{{$ApiURL}}/products:list" | jq .
```

### 4. Update a record

```bash
curl -X POST "{{$ApiURL}}/products:update" \
  -H "Content-Type: application/json" \
  -d '{"id":"01ARZ3NDEKTSV4RRFFQ69G5FBX","data":{"price":899.99}}'
```

### 5. Delete a record

```bash
curl -X POST "{{$ApiURL}}/products:destroy" \
  -H "Content-Type: application/json" \
  -d '{"id":"01ARZ3NDEKTSV4RRFFQ69G5FBX"}'
```

### 6. List records with filtering

```bash
curl -s "{{$ApiURL}}/products:list?price[gt]=20&sort=-price" | jq .
```

### 7. Count records

```bash
curl -s "{{$ApiURL}}/products:count"
```

**Response (200 OK):**

```json
{"value": 42}
```

### 8. Sum with filter

```bash
curl -s "{{$ApiURL}}/products:sum?field=price&category[eq]=electronics"
```

**Response (200 OK):**

```json
{"value": 1599.99}
```
