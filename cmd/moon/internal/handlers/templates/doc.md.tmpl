{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}
# Moon â€“ Instructions and API Documentation for AI Coding Agents

- Moon is a schema-on-demand backend.
- Always create collections before inserting data.
- Prefer API keys for server-side apps.
- Use JWT only for user-facing authentication.
- Do not assume foreign keys; model relations manually.
- Endpoints use AIP-136 custom actions (colon separator).

| Property    | Value                                               |
|-------------|-----------------------------------------------------|
| Version     | {{.Version}}                                        |
| Service     | moon                                                |
| Base URL    | `{{.BaseURL}}`                                      |
| URL Prefix  | {{if .Prefix}}`{{.Prefix}}`{{else}}N/A{{end}}       |
| Documentation Version     | 1.3.0                                 |
| Github URL  | https://github.com/thalib/moon                      |

{{if .Prefix}} All endpoints are prefixed with `{{.Prefix}}`. {{end}}


## Table of Contents

- [Intro](#intro)
- [Authentication](#authentication)
- [Response Format](#response-format)
- [Data Types](#data-types)
- [Health Check](#health-check)
- [Auth Endpoints](#auth-endpoints)
- [User Management Endpoints](#user-management-endpoints)
- [API Key Management Endpoints](#api-key-management-endpoints)
- [Collection Management](#collection-management)
- [Data Access](#data-access)
- [Query Options](#query-options)
- [Aggregation Operations](#aggregation-operations)
- [Rate Limiting](#rate-limiting)
- [CORS Configuration](#cors-configuration)
- [Security Best Practices](#security-best-practices)
- [Documentation](#documentation)
- [JSON Appendix](#json-appendix)

## Intro

Moon enables rapid, migrationless management of database tables and records through a dynamic RESTful API.




### Moon Terminology

Moon stores data in the format: Collection, Field, and Record.

In database terminology, these are Tables, Columns, and Rows, respectively.

For example, consider the table `products` below.

```md
| id        | name           | price   | in_stock |
|-----------|----------------|---------|----------|
| 01H1...   | Wireless Mouse | 29.99   | true     |
| 01H2...   | USB Keyboard   | 19.99   | false    |
```

- **Collection:** `products` (the table)
- **Field:** `id`, `name`, `price`, `in_stock` (the columns)
- **Record:** Each row, e.g., `{ "id": "01H1...", "name": "Wireless Mouse", "price": "29.99", "in_stock": true }`

### Design Constraints

- Collection names must be lowercase, snake_case
- Field names must be unique per collection
- No joins are supported
- Relations must be handled at application layer

### What Moon Does NOT Do

Moon is designed as a lightweight, dynamic backend. It intentionally does **not** support:

- **Transactions:** No multi-statement atomic operations. Each request is independent.
- **Joins:** No SQL joins between collections. Model relationships at the application layer.
- **Triggers/Hooks:** No database-level triggers or event hooks.
- **Background Jobs:** No built-in job queue or async task processing.

### Supported HTTP Methods

**Moon only supports GET and POST HTTP methods.** All other HTTP methods (PUT, DELETE, PATCH, etc.) are not supported.

- **GET** is used for read operations (list, get, count, aggregation queries)
- **POST** is used for write operations (create, update, destroy) and authentication operations
- **OPTIONS** is supported for CORS preflight requests only

This design:
- Simplifies the API and makes it universally compatible
- Uses the AIP-136 custom actions pattern where the action is in the URL (`:create`, `:update`, `:destroy`)
- Works with all HTTP clients and restrictive network environments

## Authentication 

{{if or .JWTEnabled .APIKeyEnabled}}This API requires authentication for all endpoints except `/health`.

{{if .JWTEnabled}}**JWT Authentication:** Include a bearer token in the Authorization header:

```
Authorization: Bearer <your-jwt-token>
```

To use the examples below, first login and store your token:

```bash

# Login and save tokens to environment variables
response=$(curl -s -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}')
ACCESS_TOKEN=$(echo $response | jq -r '.access_token')
REFRESH_TOKEN=$(echo $response | jq -r '.refresh_token')

# Use in subsequent requests
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

{{end}}{{if .APIKeyEnabled}}**API Key Authentication:** Include your API key in the {{.APIKeyHeader}} header:

```
{{.APIKeyHeader}}: <your-api-key>
```

{{end}}{{else}}Authentication is currently disabled for this instance.

{{end}}

## Response Format

All successful responses return JSON with relevant data.

**Common Status Codes:**

- `200 OK` - Successful GET requests
- `201 Created` - Successful POST requests creating resources
- `400 Bad Request` - Invalid input, missing required field, invalid filter operator
- `404 Not Found` - Collection or record not found
- `409 Conflict` - Collection already exists
- `500 Internal Server Error` - Server error

**Success Responses (201 Created)**

```json
{
  "message": "Collection created successfully",
  "collection": {
    "name": "products",
    "columns": [...]
  }
}
```

**Error Responses**

All errors follow a consistent JSON structure:

```json
{
  "error": "Error message describing what went wrong",
  "code": 400
}
```

**Common Error Examples:**

401 Unauthorized (invalid or missing token):
```json
{
  "error": "Unauthorized",
  "code": 401
}
```

403 Forbidden (insufficient permissions):
```json
{
  "error": "Forbidden: admin role required",
  "code": 403
}
```

404 Not Found (collection or record not found):
```json
{
  "error": "Collection not found: products",
  "code": 404
}
```

400 Bad Request (invalid input):
```json
{
  "error": "Invalid filter operator: invalid",
  "code": 400
}
```

429 Too Many Requests (rate limit exceeded):
```json
{
  "error": "Rate limit exceeded. Try again later.",
  "code": 429
}
```

## Data Types

Supported column data types:

- `string` - Text values of any length (maps to TEXT in SQL)
- `integer` - 64-bit whole numbers
- `boolean` - true/false values
- `datetime` - Date/time in RFC3339 or ISO 8601 format (e.g., 2023-01-31T13:45:00Z)
- `json` - Arbitrary JSON object or array
- `decimal` - For decimal values. API input/output uses strings (e.g., `"199.99"`), with a default of 2 decimal places.

***Note:*** Aggregation functions (sum, avg, min, max) are supported on both `integer` and `decimal` field types. SQLite may represent boolean values as `1` (true) or `0` (false) in some responses.

## Health Check

```bash
curl -s  http://localhost:6006/health | jq .
```

Response: `status: live|down`

```bash
{
  "name": "moon",
  "status": "live",
  "version": "1.99"
}
```

## Auth Endpoints

| Endpoint       | Method | Description                                 |
|----------------|--------|---------------------------------------------|
| /auth:login    | POST   | Authenticate user, receive tokens           |
| /auth:logout   | POST   | Invalidate current session's refresh token  |
| /auth:refresh  | POST   | Exchange refresh token for new tokens       |
| /auth:me       | GET    | Get current authenticated user info         |
| /auth:me       | POST   | Update current user's profile/password      |

**Login**

```bash
curl -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}' | jq .
```
Use the username/password defined in the config file `samples/moon.conf` under `auth.bootstrap_admin`.

**Logout**

```bash
curl -X POST "{{$ApiURL}}/auth:logout" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"$REFRESH_TOKEN"}' | jq .
```

**Refresh Token**

```bash
curl -X POST "{{$ApiURL}}/auth:refresh" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"$REFRESH_TOKEN"}' | jq .
```

**Get Current User**

```bash
curl -X GET "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Update Current User (Email)**

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email":"newemail@example.com"}' | jq .
```

**Update Current User (Change Password)**

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"old_password":"moonadmin12#","password":"NewSecurePass456"}' | jq .
```

## User Management Endpoints

| Endpoint        | Method | Description                              |
|-----------------|--------|------------------------------------------|
| /users:list     | GET    | List all users (admin only)              |
| /users:get      | GET    | Get specific user by ID (admin only)     |
| /users:create   | POST   | Create new user (admin only)             |
| /users:update   | POST   | Update user properties or admin actions  |
| /users:destroy  | POST   | Delete user account (admin only)         |

**List All Users**

```bash
curl -X GET "{{$ApiURL}}/users:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Get Specific User by ID**

```bash
curl -X GET "{{$ApiURL}}/users:get?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Create New User**

```bash
curl -X POST "{{$ApiURL}}/users:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "UserPass123#",
    "role": "user"
  }' | jq .
```

Response includes the new user with `user.id`:

```json
{
  "message": "User created successfully",
  "user": {
    "id": "01KGF1ABCDEFGH123456789",
    "username": "newuser",
    "email": "newuser@example.com",
    "role": "user",
    "created_at": "2026-02-03T10:30:00Z"
  }
}
```

**Update User Properties**

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "updateduser@example.com",
    "role": "admin"
  }' | jq .
```

**Admin Actions: Reset User Password**

Admins can reset a user's password using the `reset_password` action:

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "reset_password",
    "password": "NewSecurePassword123#"
  }' | jq .
```

**Admin Actions: Revoke All User Sessions**

Admins can invalidate all refresh tokens for a user using the `revoke_sessions` action:

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action": "revoke_sessions"}' | jq .
```

**Delete User Account**

```bash
curl -X POST "{{$ApiURL}}/users:destroy?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

## API Key Management Endpoints

| Endpoint         | Method | Description                                 |
|------------------|--------|---------------------------------------------|
| /apikeys:list    | GET    | List all API keys (metadata only, admin)    |
| /apikeys:get     | GET    | Get specific API key metadata (admin only)  |
| /apikeys:create  | POST   | Create new API key (admin only)             |
| /apikeys:update  | POST   | Update API key metadata or rotate key       |
| /apikeys:destroy | POST   | Delete API key (admin only)                 |

**List API Keys**

```bash
curl -X GET "{{$ApiURL}}/apikeys:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Get API Key Metadata**

```bash
curl -X GET "{{$ApiURL}}/apikeys:get?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Create API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false
  }' | jq .
```

Example Response 

```bash 
{
  "message": "API key created successfully",
  "warning": "Store this key securely. It will not be shown again.",
  "apikey": {
    "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false,
    "created_at": "2026-02-02T11:09:07Z"
  },
  "key": "moon_live_ArPaQDdyh4gp9EKF42Xrq7AOAAJZmKiCtTCv1m2rj931QxmPkiXuSV8Un0qllMiN"
}
```

- In above reposne fields:
  - `id` => `$API_KEY_ID` (e.g: 01KGF0NGEHYKJR8PV5KHQBDHKB)
  - `key` => `$API_KEY` (e.g: moon_live_ArPaQDdyh4gp9EKF42Xrq7AOAAJZmKiCtTCv1m2rj931QxmPkiXuSV8Un0qllMiN).
- Copy and store `key` securely now. It will not be shown again.
- Use this key in the header specified by `$API_KEY` for requests using `X-API-Key`.

**Update API Key Metadata**

Update metadata such as name, description, or can_write permissions **without** regenerating the key:

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Service Name",
    "description": "Updated description",
    "can_write": true
  }' | jq .
```

***Note:*** This operation updates metadata only. The API key itself remains unchanged and valid. To regenerate the key, use the explicit rotation action below.

**Rotate API Key**

To generate a new key and invalidate the old one, use the explicit `action: "rotate"`:

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action":"rotate"}' | jq .
```

Response includes the new key and a warning:

```json
{
  "message": "API key rotated successfully",
  "warning": "Old key is now invalid. Store this new key securely.",
  "apikey": {
    "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
    "name": "Integration Service",
    "role": "user",
    "can_write": false
  },
  "key": "moon_live_NewKeyValueHere..."
}
```

**Delete API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:destroy?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Example usage with API key**

```
response=$(curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Service",
    "description": "Key for testing",
    "role": "user",
    "can_write": true
  }')
API_KEY=$(echo $response | jq -r '.key')
```

then you can use like below 

```bash
curl -X GET "http://localhost:6006/collections:list" \
  -H "X-API-Key: $API_KEY" | jq .
```

## Collection Management

These endpoints manage database tables (collections) and their schemas.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

**List Collections**

```bash
curl -s {{$ApiURL}}/collections:list \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Create a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "description", "type": "string", "nullable": true}
    ]
  }' | jq .
```

**Get Collection Schema**

```bash
curl -s {{$ApiURL}}/collections:get?name=products \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Update a Collection Schema**

Update collection schemas using one or more of the following operations:

- `add_columns` - Add new columns
- `rename_columns` - Rename existing columns
- `modify_columns` - Change column types or attributes
- `remove_columns` - Remove existing columns

Add new columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
      {"name": "stock", "type": "integer", "nullable": false},
			{"name": "category", "type": "string", "nullable": false}
		]
	}' | jq .
```

Rename existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"rename_columns": [
			{"old_name": "description", "new_name": "details"}
		]
	}' | jq .
```

Modify existing columns' data types or attributes:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"modify_columns": [
			{"name": "category", "type": "string" , "nullable": true}
		]
	}' | jq .
```

Remove existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"remove_columns": ["category"]
	}' | jq .
```

Combine multiple operations:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
			{"name": "brand", "type": "string", "nullable": false}
		],
		"rename_columns": [
			{"old_name": "stock", "new_name": "quantity"}
		],
		"modify_columns": [
			{"name": "price", "type": "string", "nullable": false}
		]
	}' | jq .
```

**Delete a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:destroy" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "products"}' | jq .
```

## Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

**List All Records**

```bash
curl -s "{{$ApiURL}}/products:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Create a New Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity" : 10,
      "brand": "Wow"
    }
  }' | jq .
```

Response includes the created record with `data.id`:

```json
{
  "message": "Record created successfully",
  "data": {
    "id": "01KGD5E74RYS0WTNARQC92S1P7",
    "title": "Wireless Mouse",
    "price": "29.99",
    "details": "Ergonomic wireless mouse",
    "quantity": 10,
    "brand": "Wow",
    "created_at": "2026-02-03T10:45:00Z",
    "updated_at": "2026-02-03T10:45:00Z"
  }
}
```

**Get a Single Record**

```bash
# First, get the ID from a list or create operation, then:
curl -s "{{$ApiURL}}/products:get?id=<RECORD_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

***Note:*** Replace `<RECORD_ID>` with an actual record ID from your data (e.g., `01KGD5E74RYS0WTNARQC92S1P7`).

**Update an Existing Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:update" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>","data":{"price":"6000.00"}}' | jq .
```

**Delete a Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:destroy" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>"}' | jq .
```

---

## Query Options

**Filtering:** `?column[operator]=value` 

```bash
curl -g "{{$ApiURL}}/products:list?quantity[gt]=5&brand[eq]=Wow" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Operators:** `eq`, `ne`, `gt`, `lt`, `gte`, `lte`, `like`, `in`

**Sorting:** `?sort={-field1,field2}` 

```bash
curl "{{$ApiURL}}/products:list?sort=-quantity,title" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Sort by `field` (ascending) or `-field` (descending).

**Full-Text Search:** `?q={search_term}` (across all text columns)

```bash
curl "{{$ApiURL}}/products:list?q=mouse" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Searches across all string/text fields in the collection.

**Field Selection:** `?fields={field1,field2}`

```bash
curl "{{$ApiURL}}/products:list?fields=quantity,title" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Returns only the specified fields (plus `id` which is always included).

**Limit:** `?limit={limit}`

```bash
curl "{{$ApiURL}}/products:list?limit=2" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Pagination:** `?after={cursor}` (Response includes `next_cursor` when more results are available.)

```bash
curl "{{$ApiURL}}/products:list?after=01ARZ3NDEKTSV4RRFFQ69G5FBX&limit=10" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Combined Query Examples:**

Filter, sort, and limit:
```bash
curl -g "{{$ApiURL}}/products:list?quantity[gte]=10&price[lt]=100&sort=-price&limit=5" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Search with category filter and field selection:
```bash
curl -g "{{$ApiURL}}/products:list?q=laptop&brand[eq]=Wow&fields=title,price,quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Multiple filters with pagination:
```bash
curl -g "{{$ApiURL}}/products:list?price[gte]=100&quantity[gt]=0&sort=-price&limit=10&after=01ARZ3NDEK" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

---

## Aggregation Operations

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |


**Count Records:** `:count`

```bash
curl "{{$ApiURL}}/products:count" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Sum Numeric Field:** `:sum?field={field_name}`

```bash
curl "{{$ApiURL}}/products:sum?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Average Numeric Field:** `:avg?field={field_name}`

```bash
curl "{{$ApiURL}}/products:avg?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Minimum Value:** `:min?field={field_name}`

```bash
curl "{{$ApiURL}}/products:min?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Maximum Value:** `:max?field={field_name}`

```bash
curl "{{$ApiURL}}/products:max?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

***Note:*** Aggregation functions (sum, avg, min, max) work on both `integer` and `decimal` field types. In the examples above, `price` was changed to `string` type during schema updates, so we use `quantity` for demonstrations. For decimal fields, aggregation results are returned as strings (e.g., `"1234.56"`).

---

## Rate Limiting

Moon enforces rate limiting to protect server resources and ensure fair usage. Rate limits differ based on authentication method:

- **JWT Authentication:** 100 requests per minute per user
- **API Key Authentication:** 1,000 requests per minute per API key

### Rate Limit Headers

Every response includes rate limit information in the headers:

- `X-RateLimit-Limit`: Maximum requests allowed in the time window
- `X-RateLimit-Remaining`: Number of requests remaining in current window
- `X-RateLimit-Reset`: Unix timestamp when the rate limit resets

**Example Response Headers:**

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1706875200
```

**Rate Limit Exceeded Response (429):**

When you exceed the rate limit, you'll receive:

```json
{
  "error": "Rate limit exceeded. Try again later.",
  "code": 429
}
```

Wait until the time specified in `X-RateLimit-Reset` before retrying.

---

## CORS Configuration

Moon supports Cross-Origin Resource Sharing (CORS) for browser-based clients.

### Supported Methods

The server accepts the following HTTP methods via CORS:

- `GET`, `POST`

### OPTIONS Requests

Use OPTIONS to check allowed methods and headers for any endpoint:

```bash
curl -s -X OPTIONS "{{$ApiURL}}/collections:list" \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: GET" | jq .
```

**Response Headers:**

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Authorization, Content-Type, X-API-Key
Access-Control-Max-Age: 3600
```

### CORS Configuration

- **Allowed Origins:** Configurable via `cors.allowed_origins` in `moon.conf`
- **Allowed Headers:** `Authorization`, `Content-Type`, `X-API-Key`
- **Credentials:** Supported when origin is explicitly allowed (not `*`)

---

## Security Best Practices

### Authentication

1. **Use JWT for User-Facing Apps:**
   - Short-lived access tokens (15 minutes default)
   - Refresh tokens for session management
   - Store tokens securely (HttpOnly cookies recommended)

2. **Use API Keys for Server-to-Server:**
   - Long-lived, high-rate-limit keys
   - Store keys in environment variables or secret managers
   - Never commit keys to version control
   - Rotate keys regularly using the `:update` action with `"action": "rotate"`

### Authorization

1. **Principle of Least Privilege:**
   - Use `role: "user"` for read-only or limited-write access
   - Reserve `role: "admin"` for trusted users/services only
   - Set `can_write: false` on API keys when read-only access is sufficient

2. **Admin Endpoints:**
   - All user, API key, and collection management endpoints require admin role
   - Regular users can only access data endpoints within their permissions

### Input Validation

1. **Always Validate Input:**
   - Moon validates data types and column constraints
   - Application layer should validate business logic rules
   - Sanitize user input before querying

2. **Query Safety:**
   - Use parameterized filters (e.g., `?field[eq]=value`)
   - Avoid constructing raw SQL queries
   - Moon prevents SQL injection via prepared statements

### Network Security

1. **Use HTTPS in Production:**
   - Always use TLS/SSL for production deployments
   - Never transmit tokens or API keys over unencrypted connections

2. **Rate Limiting:**
   - Monitor rate limit headers to avoid hitting limits
   - Implement exponential backoff for retries

3. **CORS:**
   - Configure specific allowed origins in production
   - Avoid using `*` wildcard for sensitive applications

---

## Documentation

View HTML documentation in your browser: [{{$ApiURL}}/doc/]({{$ApiURL}}/doc/)

Get Markdown documentation (for humans and AI coding agents) via curl:
```bash
curl "{{$ApiURL}}/doc/md"
```
Or view in browser: [{{$ApiURL}}/doc/md]({{$ApiURL}}/doc/md)

Refresh documentation cache:
```bash
curl -X POST "{{$ApiURL}}/doc:refresh" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

---

**[Moon](https://github.com/thalib/moon)** made by [Devnodes.in](https://devnodes.in)

---

## JSON Appendix

This machine-readable appendix enables automated client generation and reduces ambiguity for AI coding agents.

```json
{
  "service": "moon",
  "version": "{{.Version}}",
  "document_version": "1.3.0",
  "base_url": "{{.BaseURL}}",
  {{if .Prefix}}"url_prefix": "{{.Prefix}}",{{else}}"url_prefix": null,{{end}}

  "authentication": {
    "modes": [{{if .JWTEnabled}}"jwt"{{if .APIKeyEnabled}}, {{end}}{{end}}{{if .APIKeyEnabled}}"api_key"{{end}}],
    "headers": {
      {{if .JWTEnabled}}"jwt": "Authorization: Bearer <token>"{{if .APIKeyEnabled}},{{end}}{{end}}
      {{if .APIKeyEnabled}}"api_key": "{{.APIKeyHeader}}: <key>"{{end}}
    },
    "rate_limits": {
      "jwt": "100 requests per minute per user",
      "api_key": "1000 requests per minute per key"
    },
    "rules": {
      "jwt_for": "user-facing apps with session management",
      "api_key_for": "server-to-server or backend services"
    }
  },

  "collections": {
    "terminology": {
      "collection": "table/database collection",
      "field": "column/table column",
      "record": "row/table row"
    },
    "naming": {
      "case": "snake_case",
      "lowercase": true,
      "pattern": "^[a-z][a-z0-9_]*$"
    },
    "constraints": {
      "joins_supported": false,
      "foreign_keys": false,
      "transactions": false,
      "triggers": false,
      "background_jobs": false
    }
  },

  "data_types": [
    {
      "name": "string",
      "description": "Text values of any length",
      "sql_mapping": "TEXT",
      "example": "Wireless Mouse"
    },
    {
      "name": "integer",
      "description": "64-bit whole numbers",
      "sql_mapping": "INTEGER",
      "example": 42
    },
    {
      "name": "boolean",
      "description": "true/false values",
      "sql_mapping": "BOOLEAN",
      "example": true,
      "note": "SQLite may represent as 1 (true) or 0 (false)"
    },
    {
      "name": "datetime",
      "description": "Date/time in RFC3339 or ISO 8601 format",
      "sql_mapping": "DATETIME",
      "example": "2023-01-31T13:45:00Z"
    },
    {
      "name": "json",
      "description": "Arbitrary JSON object or array",
      "sql_mapping": "JSON",
      "example": {"key": "value"}
    },
    {
      "name": "decimal",
      "description": "Decimal values with precision",
      "sql_mapping": "DECIMAL",
      "format": "string",
      "example": "199.99",
      "note": "API input/output uses strings, default 2 decimal places"
    }
  ],

  "endpoints": {
    "health": {
      "path": "/health",
      "method": "GET",
      "auth_required": false,
      "description": "Health check endpoint"
    },
    "authentication": {
      "login": {
        "path": "/auth:login",
        "method": "POST",
        "auth_required": false,
        "description": "Authenticate user, receive JWT tokens"
      },
      "logout": {
        "path": "/auth:logout",
        "method": "POST",
        "auth_required": true,
        "description": "Invalidate current session's refresh token"
      },
      "refresh": {
        "path": "/auth:refresh",
        "method": "POST",
        "auth_required": false,
        "description": "Exchange refresh token for new access token"
      },
      "me": {
        "path": "/auth:me",
        "methods": ["GET", "POST"],
        "auth_required": true,
        "description": "Get or update current user profile"
      }
    },
    "user_management": {
      "list": {
        "path": "/users:list",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin"
      },
      "get": {
        "path": "/users:get",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"]
      },
      "create": {
        "path": "/users:create",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin"
      },
      "update": {
        "path": "/users:update",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"],
        "actions": ["reset_password", "revoke_sessions"]
      },
      "destroy": {
        "path": "/users:destroy",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"]
      }
    },
    "apikey_management": {
      "list": {
        "path": "/apikeys:list",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin"
      },
      "get": {
        "path": "/apikeys:get",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"]
      },
      "create": {
        "path": "/apikeys:create",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin"
      },
      "update": {
        "path": "/apikeys:update",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"],
        "actions": ["rotate"]
      },
      "destroy": {
        "path": "/apikeys:destroy",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "params": ["id"]
      }
    },
    "collection_management": {
      "list": {
        "path": "/collections:list",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin"
      },
      "get": {
        "path": "/collections:get",
        "method": "GET",
        "auth_required": true,
        "role_required": "admin",
        "params": ["name"]
      },
      "create": {
        "path": "/collections:create",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin"
      },
      "update": {
        "path": "/collections:update",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "operations": ["add_columns", "rename_columns", "modify_columns", "remove_columns"]
      },
      "destroy": {
        "path": "/collections:destroy",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin"
      }
    },
    "data_access": {
      "list": {
        "path": "/{collection}:list",
        "method": "GET",
        "auth_required": true,
        "description": "List records in collection"
      },
      "get": {
        "path": "/{collection}:get",
        "method": "GET",
        "auth_required": true,
        "params": ["id"],
        "description": "Get single record by ID"
      },
      "create": {
        "path": "/{collection}:create",
        "method": "POST",
        "auth_required": true,
        "description": "Create new record"
      },
      "update": {
        "path": "/{collection}:update",
        "method": "POST",
        "auth_required": true,
        "description": "Update existing record"
      },
      "destroy": {
        "path": "/{collection}:destroy",
        "method": "POST",
        "auth_required": true,
        "description": "Delete record"
      }
    },
    "aggregation": {
      "count": {
        "path": "/{collection}:count",
        "method": "GET",
        "auth_required": true,
        "description": "Count records"
      },
      "sum": {
        "path": "/{collection}:sum",
        "method": "GET",
        "auth_required": true,
        "params": ["field"],
        "description": "Sum numeric field"
      },
      "avg": {
        "path": "/{collection}:avg",
        "method": "GET",
        "auth_required": true,
        "params": ["field"],
        "description": "Average numeric field"
      },
      "min": {
        "path": "/{collection}:min",
        "method": "GET",
        "auth_required": true,
        "params": ["field"],
        "description": "Minimum value"
      },
      "max": {
        "path": "/{collection}:max",
        "method": "GET",
        "auth_required": true,
        "params": ["field"],
        "description": "Maximum value"
      }
    },
    "documentation": {
      "html": {
        "path": "/doc/",
        "method": "GET",
        "auth_required": false,
        "description": "HTML documentation"
      },
      "markdown": {
        "path": "/doc/md",
        "method": "GET",
        "auth_required": false,
        "description": "Markdown documentation"
      },
      "refresh": {
        "path": "/doc:refresh",
        "method": "POST",
        "auth_required": true,
        "role_required": "admin",
        "description": "Refresh documentation cache"
      }
    }
  },

  "query": {
    "operators": ["eq", "ne", "gt", "lt", "gte", "lte", "like", "in"],
    "syntax": {
      "filter": "?column[operator]=value",
      "examples": [
        "?price[gte]=100",
        "?category[eq]=electronics",
        "?name[like]=%mouse%"
      ]
    },
    "sorting": {
      "syntax": "?sort={field1,-field2}",
      "ascending": "field",
      "descending": "-field",
      "example": "?sort=-price,name"
    },
    "pagination": {
      "cursor_param": "after",
      "limit_param": "limit",
      "example": "?limit=10&after=01ARZ3NDEKTSV4RRFFQ69G5FBX"
    },
    "search": {
      "full_text_param": "q",
      "description": "Searches across all text/string columns",
      "example": "?q=wireless"
    },
    "field_selection": {
      "param": "fields",
      "description": "Return only specified fields (id always included)",
      "example": "?fields=name,price"
    }
  },

  "aggregation": {
    "supported": ["count", "sum", "avg", "min", "max"],
    "numeric_types": ["integer", "decimal"],
    "note": "Aggregation functions work on integer and decimal field types only"
  },

  "http_status_codes": {
    "200": "OK - Successful GET request",
    "201": "Created - Successful POST request creating resource",
    "400": "Bad Request - Invalid input or parameters",
    "401": "Unauthorized - Missing or invalid authentication",
    "403": "Forbidden - Insufficient permissions",
    "404": "Not Found - Resource not found",
    "409": "Conflict - Resource already exists",
    "429": "Too Many Requests - Rate limit exceeded",
    "500": "Internal Server Error - Server error"
  },

  "rate_limiting": {
    "headers": {
      "limit": "X-RateLimit-Limit",
      "remaining": "X-RateLimit-Remaining",
      "reset": "X-RateLimit-Reset"
    }
  },

  "cors": {
    "allowed_methods": ["GET", "POST", "OPTIONS"],
    "allowed_headers": ["Authorization", "Content-Type", "X-API-Key"],
    "configurable": true,
    "config_file": "samples/moon.conf",
    "config_key": "cors.allowed_origins"
  },

  "guarantees": {
    "transactions": false,
    "joins": false,
    "foreign_keys": false,
    "triggers": false,
    "background_jobs": false
  },

  "aip_standards": {
    "custom_actions": "AIP-136",
    "pattern": "resource:action",
    "separator": ":",
    "description": "APIs use colon separator between resource and action for predictable interface"
  }
}
```

---

