{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}

# Moon – Instructions and API Documentation for AI Coding Agents

> **Quick Start:**
> 1. [View HTML docs]({{$ApiURL}}/doc/) or [Markdown docs]({{$ApiURL}}/doc/llms-full.txt)
> 2. [Authenticate](#authentication) (see below)
> 3. [Try a sample request](#collection-management)
> 4. [See JSON Appendix](#json-appendix) for machine-readable spec
> 5. For help or to report issues, visit [GitHub Issues](https://github.com/devnodesin/moon/issues)

| Property    | Value                                               |
|-------------|-----------------------------------------------------|
| Version     | {{.Version}}                                        |
| Service     | moon                                                |
| Base URL    | `{{.BaseURL}}`                                      |
| URL Prefix  | {{if .Prefix}}`{{.Prefix}}`{{else}}N/A{{end}}       |
| Documentation Version     | 1.5.1                                 |
| Github URL  | https://github.com/devnodesin/moon                      |

{{if .Prefix}} All endpoints are prefixed with `{{.Prefix}}`. {{end}}


## Table of Contents

- [Intro](#intro)
- [Health and Documentation](#health-and-documentation)
- [Authentication](#authentication)
- [Manage User (Admin Only)](#manage-user-admin-only)
- [Manage API Keys (Admin Only)](#manage-api-keys-admin-only)
- [Manage Collections](#manage-collections)
- [Data Access](#data-access)
- [Query Options](#query-options)
- [Aggregation Operations](#aggregation-operations)
- [Security](#security)
- [JSON Appendix](#json-appendix)

## Intro

{{ include "001-intro.md" }}

---

## Health and Documentation

{{ include "010-health.md" }}

{{ include "011-doc.md" }}
---

## Authentication

| Endpoint       | Method | Description                                 |
|----------------|--------|---------------------------------------------|
| /auth:login    | POST   | Authenticate user, receive tokens           |
| /auth:logout   | POST   | Invalidate current session's refresh token  |
| /auth:refresh  | POST   | Exchange refresh token for new tokens       |
| /auth:me       | GET    | Get current authenticated user info         |
| /auth:me       | POST   | Update current user's profile/password      |

{{ include "020-auth.md" }}

---

## Manage User (Admin Only)

| Endpoint        | Method | Description                              |
|-----------------|--------|------------------------------------------|
| /users:list     | GET    | List all users                           |
| /users:get      | GET    | Get specific user by ID                  |
| /users:create   | POST   | Create new user                          |
| /users:update   | POST   | Update user properties or admin actions  |
| /users:destroy  | POST   | Delete user account                      |

{{ include "030-users.md" }}

---

## Manage API Keys (Admin Only)

| Endpoint         | Method | Description                                 |
|------------------|--------|---------------------------------------------|
| /apikeys:list    | GET    | List all API keys                           |
| /apikeys:get     | GET    | Get specific API key                        |
| /apikeys:create  | POST   | Create new API key                          |
| /apikeys:update  | POST   | Update API key metadata or rotate key       |
| /apikeys:destroy | POST   | Delete API key                              |

{{ include "040-apikeys.md" }}

---

## Manage Collections

These endpoints manage database tables (collections) and their schemas.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

Update collection support following schema modification operations:

- `add_columns` - Add new columns
- `rename_columns` - Rename existing columns
- `modify_columns` - Change column types or attributes
- `remove_columns` - Remove existing columns


{{ include "050-collection.md" }}

---

## Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:schema` | GET | Get collection schema (read-only) |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

{{ include "060-data.md" }}

---

## Query Options

Query parameters for filtering, sorting, searching, field selection, and pagination when listing records. Using these options allows you to retrieve specific subsets of data based on your criteria.

| Query Options | Description |
|---------------|-------------|
| `?column[operator]=value` | Filter records by column values using comparison operators |
| `?sort={fields}` | Sort by one or more fields (prefix `-` for descending) |
| `?q={term}` | Full-text search across all text columns |
| `?fields={field1,field2}` | Select specific fields to return (id always included) |
| `?limit={number}` | Limit number of records returned (default: 15, max: 100) |
| `?after={cursor}` | Get records after the specified cursor |

{{ include "070-query.md" }}

### Combined Query Examples

query parameters can be combined to perform complex queries. Here are some examples:

Filter, sort, and limit:
```bash
curl -g "{{$ApiURL}}/products:list?quantity[gte]=10&price[lt]=100&sort=-price&limit=5" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Search with category filter and field selection:
```bash
curl -g "{{$ApiURL}}/products:list?q=laptop&brand[eq]=Wow&fields=title,price,quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Multiple filters with pagination:
```bash
curl -g "{{$ApiURL}}/products:list?price[gte]=100&quantity[gt]=0&sort=-price&limit=10&after=01ARZ3NDEK" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

---

## Aggregation Operations

Traditional analytics and reporting often require downloading large datasets to the client for processing, which is inefficient and slow—especially for counting, summing, or calculating averages across millions of records.

Moon provides dedicated aggregation endpoints that perform calculations directly on the server. This enables fast, efficient analytics—such as counting records, summing numeric fields, computing averages, and finding minimum or maximum values—without transferring unnecessary data.

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |

***Note:***

- Aggregation can be combined with filters (e.g., `?quantity[gt]=10`) to perform calculations on specific subsets of data.
- Aggregation functions (`sum`, `avg`, `min`, `max`) are supported only on `integer` and `decimal` field types. 

{{ include "080-aggregation.md" }}

---

## Security

{{ include "091-security.md" }}

---

## JSON Appendix

This machine-readable appendix enables automated client generation and reduces ambiguity for AI coding agents.

```json
{{.JSONAppendix}}
```

---

**[Moon](https://github.com/devnodesin/moon)** made by [Devnodes.in](https://devnodes.in)

---
