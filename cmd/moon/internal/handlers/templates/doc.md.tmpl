{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}
# Moon API Documentation

Moon is a dynamic headless engine that provides a RESTful API for managing database tables and records without manual migrations. All endpoints follow the AIP-136 custom actions pattern using a colon separator between the resource and action.

| Property    | Value                                               |
|-------------|-----------------------------------------------------|
| Version     | {{.Version}}                                        |
| Service     | moon                                                |
| Base URL    | `{{.BaseURL}}`                                      |
| URL Prefix  | {{if .Prefix}}`{{.Prefix}}`{{else}}N/A{{end}}       |

{{if .Prefix}} All endpoints are prefixed with `{{.Prefix}}`. {{end}}


## Table of Contents

- [Introduction](#introduction)
- [Authentication](#authentication)
- [Response Format](#response-format)
- [Data Types](#data-types)
- [Health Check](#health-check)
- [Collection Management](#collection-management)
- [Data Access](#data-access)
- [Query Options](#query-options)
- [Aggregation Operations](#aggregation-operations)
- [Documentation](#documentation)

## Introduction

Moon stores data in the format: Collection, Field, and Record.

In database terminology, these are Tables, Columns, and Rows, respectively.

For example, consider the table `products` below.

```md
| id        | name           | price   | in_stock |
|-----------|----------------|---------|----------|
| 01H1...   | Wireless Mouse | 29.99   | true     |
| 01H2...   | USB Keyboard   | 19.99   | false    |
```

- **Collection:** `products` (the table)
- **Field:** `id`, `name`, `price`, `in_stock` (the columns)
- **Record:** Each row, e.g., `{ "id": "01H1...", "name": "Wireless Mouse", "price": "29.99", "in_stock": true }`

## Authentication 

{{if or .JWTEnabled .APIKeyEnabled}}This API requires authentication for all endpoints except `/health`.

{{if .JWTEnabled}}**JWT Authentication:** Include a bearer token in the Authorization header:

```
Authorization: Bearer <your-jwt-token>
```

To use the examples below, first login and store your token:

```bash
# Login and save token to environment variable
TOKEN=$(curl -s -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}' | jq -r '.access_token')

# Use in subsequent requests
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer $TOKEN"
```

{{end}}{{if .APIKeyEnabled}}**API Key Authentication:** Include your API key in the {{.APIKeyHeader}} header:

```
{{.APIKeyHeader}}: <your-api-key>
```

{{end}}{{else}}Authentication is currently disabled for this instance.

{{end}}

## Response Format

All successful responses return JSON with relevant data.

**Common Status Codes:**

- `200 OK` - Successful GET requests
- `201 Created` - Successful POST requests creating resources
- `400 Bad Request` - Invalid input, missing required field, invalid filter operator
- `404 Not Found` - Collection or record not found
- `409 Conflict` - Collection already exists
- `500 Internal Server Error` - Server error

**Success Responses (201 Created)**

```json
{
  "message": "Collection created successfully",
  "collection": {
    "name": "products",
    "columns": [...]
  }
}
```

**Error Responses**

All errors follow a consistent JSON structure:

```json
{
  "error": "Error message describing what went wrong",
  "code": 400
}
```

## Data Types

Supported column data types:

- `string` - Text values of any length (maps to TEXT in SQL)
- `integer` - 64-bit whole numbers
- `boolean` - true/false values
- `datetime` - Date/time in RFC3339 or ISO 8601 format (e.g., 2023-01-31T13:45:00Z)
- `json` - Arbitrary JSON object or array
- `decimal` - For decimal values. API input/output uses strings (e.g., `"199.99"`), with a default of 2 decimal places.

***Note:*** Aggregation functions are supported only on `integer` and `decimal` types.

## Health Check

```bash
curl -s  http://localhost:6006/health | jq .
```

Response: `status: live|down`

```bash
{
  "name": "moon",
  "status": "live",
  "version": "1.99"
}
```

## Auth Endpoints

| Endpoint       | Method | Description                                 |
|----------------|--------|---------------------------------------------|
| /auth:login    | POST   | Authenticate user, receive tokens           |
| /auth:logout   | POST   | Invalidate current session's refresh token  |
| /auth:refresh  | POST   | Exchange refresh token for new tokens       |
| /auth:me       | GET    | Get current authenticated user info         |
| /auth:me       | POST   | Update current user's profile/password      |

**Login**

```bash
curl -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}'
```
Use the username/password defined in the config file `samples/moon.conf` under `auth.bootstrap_admin`.

**Logout**

```bash
curl -X POST "{{$ApiURL}}/auth:logout" \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"<refresh_token>"}'
```

**Refresh Token**

```bash
curl -X POST "{{$ApiURL}}/auth:refresh" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"<refresh_token>"}'
```

**Get Current User**

```bash
curl -X GET "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer <access_token>"
```

**Update Current User (Email)**

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{"email":"newemail@example.com"}'
```

**Update Current User (Change Password)**

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{"old_password":"moonadmin12#","password":"NewSecurePass456"}'
```

## User Management Endpoints

| Endpoint        | Method | Description                              |
|-----------------|--------|------------------------------------------|
| /users:list     | GET    | List all users (admin only)              |
| /users:get      | GET    | Get specific user by ID (admin only)     |
| /users:create   | POST   | Create new user (admin only)             |
| /users:update   | POST   | Update user properties or admin actions  |
| /users:destroy  | POST   | Delete user account (admin only)         |

[TODO: Add examples for each User Management Endpoints]

## API Key Management Endpoints

| Endpoint         | Method | Description                                 |
|------------------|--------|---------------------------------------------|
| /apikeys:list    | GET    | List all API keys (metadata only, admin)    |
| /apikeys:get     | GET    | Get specific API key metadata (admin only)  |
| /apikeys:create  | POST   | Create new API key (admin only)             |
| /apikeys:update  | POST   | Update API key metadata or rotate key       |
| /apikeys:destroy | POST   | Delete API key (admin only)                 |

**List API Keys**

```bash
curl -X GET "{{$ApiURL}}/apikeys:list" \
  -H "Authorization: Bearer <admin_access_token>" | jq .
```

**Get API Key Metadata**

```bash
curl -X GET "{{$ApiURL}}/apikeys:get?id=APIKeyULID" \
  -H "Authorization: Bearer <admin_access_token>" | jq .
```

**Create API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer <admin_access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false
  }' | jq .
```

**Update API Key Metadata**

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=APIKeyULID" \
  -H "Authorization: Bearer <admin_access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Service Name",
    "description": "Updated description",
    "can_write": true
  }' | jq .
```

**Rotate API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=APIKeyULID" \
  -H "Authorization: Bearer <admin_access_token>" \
  -H "Content-Type: application/json" \
  -d '{"action":"rotate"}' | jq .
```

**Delete API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:destroy?id=APIKeyULID" \
  -H "Authorization: Bearer <admin_access_token>" | jq .
```

## Collection Management

These endpoints manage database tables (collections) and their schemas.

***Note:*** All collection and data endpoints require authentication. The examples below use `$TOKEN` - set it first by running:
```bash
TOKEN=$(curl -s -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}' | jq -r '.access_token')
```

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

**List Collections**

```bash
curl -s {{$ApiURL}}/collections:list \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Create a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:create" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "description", "type": "string", "nullable": true}
    ]
  }' | jq .
```

**Get Collection Schema**

```bash
curl -s {{$ApiURL}}/collections:get?name=products \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Update a Collection Schema**

Update collection schemas using one or more of the following operations:

- `add_columns` - Add new columns
- `rename_columns` - Rename existing columns
- `modify_columns` - Change column types or attributes
- `remove_columns` - Remove existing columns

Add new columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
      {"name": "stock", "type": "integer", "nullable": false},
			{"name": "category", "type": "string", "nullable": false}
		]
	}' | jq .
```

Rename existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"rename_columns": [
			{"old_name": "description", "new_name": "details"}
		]
	}' | jq .
```

Modify existing columns' data types or attributes:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"modify_columns": [
			{"name": "category", "type": "string" , "nullable": true}
		]
	}' | jq .
```

Remove existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"remove_columns": ["category"]
	}' | jq .
```

Combine multiple operations:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
			{"name": "brand", "type": "string", "nullable": false}
		],
		"rename_columns": [
			{"old_name": "stock", "new_name": "quantity"}
		],
		"modify_columns": [
			{"name": "price", "type": "string", "nullable": false}
		]
	}' | jq .
```

**Delete a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:destroy" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "products"}' | jq .
```

## Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

**List All Records**

```bash
curl -s "{{$ApiURL}}/products:list" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Create a New Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:create" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity" : 10,
      "brand": "Wow"
    }
  }' | jq .
```

**Get a Single Record**

```bash
# First, get the ID from a list or create operation, then:
curl -s "{{$ApiURL}}/products:get?id=<RECORD_ID>" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

***Note:*** Replace `<RECORD_ID>` with an actual record ID from your data (e.g., `01KGD5E74RYS0WTNARQC92S1P7`).

**Update an Existing Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:update" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>","data":{"price":"6000.00"}}' | jq .
```

**Delete a Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:destroy" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>"}' | jq .
```

---

## Query Options

**Filtering:** `?column[operator]=value` 

```bash
curl -g "{{$ApiURL}}/products:list?quantity[gt]=5&brand[eq]=Wow" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Operators:** `eq`, `ne`, `gt`, `lt`, `gte`, `lte`, `like`, `in`

**Sorting:** `?sort={-field1,field2}` 

```bash
curl "{{$ApiURL}}/products:list?sort=-quantity,title" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

Sort by `field` (ascending) or `-field` (descending).

**Full-Text Search:** `?q={search_term}` (across all text columns)

```bash
curl "{{$ApiURL}}/products:list?q=mouse" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Field Selection:** `?fields={field1,field2}`

```bash
curl "{{$ApiURL}}/products:list?fields=quantity,title" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Limit:** `?limit={limit}`

```bash
curl "{{$ApiURL}}/products:list?limit=2" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Pagination:** `?after={cursor}` (Response includes `next_cursor` when more results are available.)

```bash
curl "{{$ApiURL}}/products:list?after=01ARZ3NDEKTSV4RRFFQ69G5FBX&limit=10" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

---

## Aggregation Operations

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |


**Count Records:** `:count`

```bash
curl "{{$ApiURL}}/products:count" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Sum Numeric Field:** `:sum?field={field_name}`

```bash
curl "{{$ApiURL}}/products:sum?field=quantity" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Average Numeric Field:** `:avg?field={field_name}`

```bash
curl "{{$ApiURL}}/products:avg?field=quantity" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Minimum Value:** `:min?field={field_name}`

```bash
curl "{{$ApiURL}}/products:min?field=quantity" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

**Maximum Value:** `:max?field={field_name}`

```bash
curl "{{$ApiURL}}/products:max?field=quantity" \
  -H "Authorization: Bearer $TOKEN" | jq .
```

***Note:*** Aggregation functions (sum, avg, min, max) only work on numeric fields (`integer` and `decimal` types). In the examples above, `price` was changed to `string` type during schema updates, so we use `quantity` for min/max demonstrations.

---

## Documentation

View HTML documentation in your browser: [{{$ApiURL}}/doc/]({{$ApiURL}}/doc/)

Get Markdown documentation (for humans and AI coding agents) via curl:
```bash
curl "{{$ApiURL}}/doc/md"
```
Or view in browser: [{{$ApiURL}}/doc/md]({{$ApiURL}}/doc/md)

Refresh documentation cache:
```bash
curl -X POST "{{$ApiURL}}/doc:refresh" \
  -H "Authorization: Bearer $TOKEN"
```

---

**[Moon](https://github.com/thalib/moon)** made by [Devnodes.in](https://devnodes.in)

