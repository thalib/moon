{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}

# Moon – Instructions and API Documentation for AI Coding Agents

> **Quick Start:**
> 1. [View HTML docs]({{$ApiURL}}/doc/) or [Markdown docs]({{$ApiURL}}/doc/llms-full.txt)
> 2. [Authenticate](#authentication) (see below)
> 3. [Try a sample request](#collection-management)
> 4. [See JSON Appendix](#json-appendix) for machine-readable spec
> 5. For help or to report issues, visit [GitHub Issues](https://github.com/devnodesin/moon/issues)

| Property    | Value                                               |
|-------------|-----------------------------------------------------|
| Version     | {{.Version}}                                        |
| Service     | moon                                                |
| Base URL    | `{{.BaseURL}}`                                      |
| URL Prefix  | {{if .Prefix}}`{{.Prefix}}`{{else}}N/A{{end}}       |
| Documentation Version     | 1.5.1                                 |
| Github URL  | https://github.com/devnodesin/moon                      |

{{if .Prefix}} All endpoints are prefixed with `{{.Prefix}}`. {{end}}


## Table of Contents

- [Intro](#intro)
- [Public Endpoints](#public-endpoints)
- [Authentication](#authentication)
- [Response Format](#response-format)
- [Auth Endpoints](#auth-endpoints)
- [User Management Endpoints (Admin Only)](#user-management-endpoints-admin-only)
- [API Key Management Endpoints (Admin Only)](#api-key-management-endpoints-admin-only)
- [Collection Management](#collection-management)
- [Data Access](#data-access)
- [Query Options](#query-options)
- [Aggregation Operations](#aggregation-operations)
- [Security](#security)
- [JSON Appendix](#json-appendix)

## Intro

Moon enables rapid, migrationless management of database tables and records through a dynamic RESTful API.

**Moon Terminology**

Moon stores data in the format: Collection, Field, and Record.

In database terminology, these are Tables, Columns, and Rows, respectively.

For example, consider the table `products` below.

```md
| id        | name           | price   | in_stock |
|-----------|----------------|---------|----------|
| 01H1...   | Wireless Mouse | 29.99   | true     |
| 01H2...   | USB Keyboard   | 19.99   | false    |
```

- **Collection:** `products` (the table)
- **Field:** `id`, `name`, `price`, `in_stock` (the columns)
- **Record:** Each row, e.g., `{ "id": "01H1...", "name": "Wireless Mouse", "price": "29.99", "in_stock": true }`


**What Moon Does NOT Do**

Moon is intentionally minimal. It does **not** support:

- **Transactions:** No multi-statement atomicity; each request is independent.
- **Joins:** No SQL joins; model relationships in your application.
- **Triggers/Hooks:** No database-level triggers or event hooks.
- **Background Jobs:** No built-in job queue or async processing.
- **Foreign Keys:** Relations must be managed manually.
- **Migrations/Schema Versioning:** No built-in migration or schema versioning system.
- **Backup/Restore:** No built-in backup or restore; handle externally.
- **Fine-grained ACLs:** Only `user` and `admin` roles; no per-collection/field ACL.
- **WebSocket/Realtime:** No realtime or WebSocket support.
- **File/Binary Storage:** No file uploads or binary/blob storage.
- **Scheduled Tasks:** No cron or scheduled task support.
- **Encryption at Rest:** No built-in data encryption at rest.
- **Admin UI:** API-only; no built-in web UI or dashboard.
- **HTTP Methods:** Only supports `GET`, `POST`, and `OPTIONS` (no `PUT`, `PATCH`, or `DELETE`).
- **Public endpoints:** `/health`, `/doc`, `/doc/llms-full.txt`.

**Design Constraints**

- Collection names: lowercase, snake_case.
- Field names: unique per collection.
- No joins; handle relations at the application layer.


**Rules: Do's**

- Moon is schema-on-demand.
- Always check or create collections before inserting data.
- Use API keys for server-side apps; JWT for user-facing auth.
- Endpoints follow AIP-136 custom actions (colon separator).
- Rate limits: JWT 100/min/user, API Key 1,000/min/key.
- User roles: `user` (limited), `admin` (full).
- Input validation: types and constraints enforced; always sanitize input.
- **Always use HTTPS in production.** (All curl examples assume HTTPS for production use.)
- Set explicit allowed origins for CORS.

**Rules: Don'ts**

- Don’t use joins, transactions, triggers, or background jobs—handle these in your app.
- Don’t assume foreign keys; manage relations manually.

**Data Types**

Supported column data types:

- `string` - Text values of any length (maps to TEXT in SQL)
- `integer` - 64-bit whole numbers
- `decimal` - For decimal values. API input/output uses strings (e.g., `"199.99"`), with a default of 2 decimal places.
- `boolean` - true/false values
- `datetime` - Date/time in RFC3339 or ISO 8601 format (e.g., 2023-01-31T13:45:00Z)
- `json` - Arbitrary JSON object or array

***Note:*** Aggregation functions (sum, avg, min, max) are supported on both `integer` and `decimal` field types.

---

## Public Endpoints

**Health Check**

```bash
curl -s  http://localhost:6006/health | jq .
```

**Response (200 OK):**
```json
{
  "name": "moon",
  "status": "live",
  "version": "1.99"
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
Access-Control-Allow-Origin: *
```

**Documentation**

View HTML documentation in your browser: [{{$ApiURL}}/doc/]({{$ApiURL}}/doc/)

Get Markdown documentation (for humans and AI coding agents) via curl:
```bash
curl "{{$ApiURL}}/doc/llms-full.txt"
```
Or view in browser: [{{$ApiURL}}/doc/llms-full.txt]({{$ApiURL}}/doc/llms-full.txt)

Refresh documentation cache:
```bash
curl -X POST "{{$ApiURL}}/doc:refresh" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "message": "Documentation cache refreshed successfully"
}
```

---

## Authentication 

{{if or .JWTEnabled .APIKeyEnabled}}All requests to protected endpoints require authentication via the `Authorization` header:

```
Authorization: Bearer <TOKEN>
```

### JWT Token Example

JWT tokens are obtained from `POST /auth:login` and are used for interactive users:

```bash
# Login and save tokens to environment variables
response=$(curl -s -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}')
ACCESS_TOKEN=$(echo $response | jq -r '.access_token')
REFRESH_TOKEN=$(echo $response | jq -r '.refresh_token')

# Use in subsequent requests
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

{{if .APIKeyEnabled}}### API Key Example

API keys are obtained from `POST /apikeys:create` and are used for service integrations:

```bash
# Create an API key (requires admin role)
curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"My Service Key","role":"user"}' | jq .

# Use the API key in requests (same Authorization header format)
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer moon_live_abc123..." | jq .
```

{{end}}**Token Types:**
- **JWT tokens** (`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`) - for interactive users
{{if .APIKeyEnabled}}- **API keys** (`moon_live_<64_chars>`) - for service integrations{{end}}
- Both use the same `Authorization: Bearer` header format

{{else}}Authentication is currently disabled for this instance.

{{- end}}

---

## Response Format

All successful responses return JSON with relevant data.

**Common Status Codes:**

- `200 OK` - Successful GET requests
- `201 Created` - Successful POST requests creating resources
- `400 Bad Request` - Invalid input, missing required field, invalid filter operator
- `404 Not Found` - Collection or record not found
- `409 Conflict` - Collection already exists
- `500 Internal Server Error` - Server error

**Success Responses (201 Created)**

```json
{
  "message": "Collection created successfully",
  "collection": {
    "name": "products",
    "columns": [...]
  }
}
```

**Error Responses**

All errors follow a consistent JSON structure:

```json
{
  "error": "Error message describing what went wrong",
  "code": 400
}
```

**Common Error Examples:**

401 Unauthorized (invalid or missing token):
```json
{
  "error": "Unauthorized",
  "code": 401
}
```

403 Forbidden (insufficient permissions):
```json
{
  "error": "Forbidden: admin role required",
  "code": 403
}
```

404 Not Found (collection or record not found):
```json
{
  "error": "Collection not found: products",
  "code": 404
}
```

400 Bad Request (invalid input):
```json
{
  "error": "Invalid filter operator: invalid",
  "code": 400
}
```

429 Too Many Requests (rate limit exceeded):
```json
{
  "error": "Rate limit exceeded. Try again later.",
  "code": 429
}
```

---

## Auth Endpoints

| Endpoint       | Method | Description                                 |
|----------------|--------|---------------------------------------------|
| /auth:login    | POST   | Authenticate user, receive tokens           |
| /auth:logout   | POST   | Invalidate current session's refresh token  |
| /auth:refresh  | POST   | Exchange refresh token for new tokens       |
| /auth:me       | GET    | Get current authenticated user info         |
| /auth:me       | POST   | Update current user's profile/password      |

**Login**

```bash
curl -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}' | jq .
```
Use the username/password defined in the config file `samples/moon.conf` under `auth.bootstrap_admin`.

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMDFKWFI3...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMDFKWFI3...",
  "expires_at": "2026-02-09T04:46:07.755529166Z",
  "token_type": "Bearer",
  "user": {
    "id": "01JXRZ7HDKTSV4RRFFQ69G5FAA",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin",
    "can_write": true
  }
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 99
X-RateLimit-Reset: 1706875200
```

**Error Response (401 Unauthorized):**
```json
{
  "error": "Invalid username or password",
  "code": 401
}
```

**Logout**

```bash
curl -X POST "{{$ApiURL}}/auth:logout" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"$REFRESH_TOKEN"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "logged out successfully"
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 98
X-RateLimit-Reset: 1706875200
```

**Refresh Token**

```bash
curl -X POST "{{$ApiURL}}/auth:refresh" \
  -H "Content-Type: application/json" \
  -d '{"refresh_token":"$REFRESH_TOKEN"}' | jq .
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMDFKWFI3...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMDFKWFI3...",
  "expires_at": "2026-02-09T04:46:07.755529166Z",
  "token_type": "Bearer",
  "user": {
    "id": "01JXRZ7HDKTSV4RRFFQ69G5FAA",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin",
    "can_write": true
  }
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 97
X-RateLimit-Reset: 1706875200
```

**Error Response (401 Unauthorized):**
```json
{
  "error": "Invalid or expired refresh token",
  "code": 401
}
```

**Get Current User**

```bash
curl -X GET "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "user": {
    "id": "01JXRZ7HDKTSV4RRFFQ69G5FAA",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin",
    "can_write": true
  }
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 96
X-RateLimit-Reset: 1706875200
```

**Update Current User**

e.g: Change email

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email":"newemail@example.com"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "user updated successfully",
  "user": {
    "id": "01JXRZ7HDKTSV4RRFFQ69G5FAA",
    "username": "admin",
    "email": "newemail@example.com",
    "role": "admin",
    "can_write": true,
    "created_at": "2026-01-15T10:30:00Z",
    "updated_at": "2026-02-03T14:25:00Z"
  }
}
```

e.g: Change Password

```bash
curl -X POST "{{$ApiURL}}/auth:me" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"old_password":"moonadmin12#","password":"NewSecurePass456"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "password updated successfully"
}
```

**Error Response (401 Unauthorized):**
```json
{
  "error": "Old password is incorrect",
  "code": 401
}
```

---

## User Management Endpoints (Admin Only)

| Endpoint        | Method | Description                              |
|-----------------|--------|------------------------------------------|
| /users:list     | GET    | List all users                           |
| /users:get      | GET    | Get specific user by ID                  |
| /users:create   | POST   | Create new user                          |
| /users:update   | POST   | Update user properties or admin actions  |
| /users:destroy  | POST   | Delete user account                      |

**List All Users**

```bash
curl -X GET "{{$ApiURL}}/users:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "users": [
    {
      "id": "01JXRZ7HDKTSV4RRFFQ69G5FAA",
      "username": "admin",
      "email": "admin@example.com",
      "role": "admin",
      "created_at": "2026-01-15T10:30:00Z",
      "updated_at": "2026-01-15T10:30:00Z"
    },
    {
      "id": "01JXRZ9ABCDEFGH123456789",
      "username": "johndoe",
      "email": "john@example.com",
      "role": "user",
      "created_at": "2026-02-01T09:15:00Z",
      "updated_at": "2026-02-01T09:15:00Z"
    }
  ],
  "total": 2
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1706875200
```

**Error Response (403 Forbidden):**
```json
{
  "error": "Forbidden: admin role required",
  "code": 403
}
```

**Get Specific User by ID**

```bash
curl -X GET "{{$ApiURL}}/users:get?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "id": "01JXRZ9ABCDEFGH123456789",
  "username": "johndoe",
  "email": "john@example.com",
  "role": "user",
  "created_at": "2026-02-01T09:15:00Z",
  "updated_at": "2026-02-01T09:15:00Z"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "User not found",
  "code": 404
}
```

**Create New User**

```bash
curl -X POST "{{$ApiURL}}/users:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "UserPass123#",
    "role": "user"
  }' | jq .
```

**Response (201 Created):**
```json
{
  "message": "user created successfully",
  "user": {
    "id": "01KGF1ABCDEFGH123456789",
    "username": "newuser",
    "email": "newuser@example.com",
    "role": "user",
    "can_write": true,
    "created_at": "2026-02-03T10:30:00Z",
    "updated_at": "2026-02-03T10:30:00Z"
  }
}
```

**Response Headers:**
```
HTTP/1.1 201 Created
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 94
X-RateLimit-Reset: 1706875200
```

**Error Response (409 Conflict):**
```json
{
  "error": "Username already exists",
  "code": 409
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "error": "Password must be at least 8 characters and contain uppercase, lowercase, number, and special character",
  "code": 422
}
```

**Update User**

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "updateduser@example.com",
    "role": "admin"
  }' | jq .
```

**Response (200 OK):**
```json
{
  "message": "user updated successfully",
  "user": {
    "id": "01KGF1ABCDEFGH123456789",
    "username": "newuser",
    "email": "updateduser@example.com",
    "role": "admin",
    "can_write": true,
    "created_at": "2026-02-03T10:30:00Z",
    "updated_at": "2026-02-03T14:45:00Z"
  }
}
```

**Reset User Password**

Admins can reset a user's password using the `reset_password` action:

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "reset_password",
    "password": "NewSecurePassword123#"
  }' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Password reset successfully"
}
```

**Revoke All User Sessions**

Admins can invalidate all refresh tokens for a user using the `revoke_sessions` action:

```bash
curl -X POST "{{$ApiURL}}/users:update?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action": "revoke_sessions"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "All user sessions revoked successfully"
}
```

**Delete User Account**

```bash
curl -X POST "{{$ApiURL}}/users:destroy?id=<USER_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "message": "user deleted successfully"
}
```

---

## API Key Management Endpoints (Admin Only)

| Endpoint         | Method | Description                                 |
|------------------|--------|---------------------------------------------|
| /apikeys:list    | GET    | List all API keys                           |
| /apikeys:get     | GET    | Get specific API key                        |
| /apikeys:create  | POST   | Create new API key                          |
| /apikeys:update  | POST   | Update API key metadata or rotate key       |
| /apikeys:destroy | POST   | Delete API key                              |

**List API Keys**

```bash
curl -X GET "{{$ApiURL}}/apikeys:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "apikeys": [
    {
      "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
      "name": "Integration Service",
      "description": "Key for integration",
      "role": "user",
      "can_write": false,
      "key_prefix": "moon_live_ArPaQD...",
      "created_at": "2026-02-02T11:09:07Z",
      "last_used": "2026-02-03T10:15:00Z"
    },
    {
      "id": "01KGF2XYZABCDEFGHIJKLMNOPQ",
      "name": "Test Service",
      "description": "Key for testing",
      "role": "user",
      "can_write": true,
      "key_prefix": "moon_live_Xyz123...",
      "created_at": "2026-02-03T08:30:00Z",
      "last_used": null
    }
  ],
  "total": 2
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 93
X-RateLimit-Reset: 1706875200
```

**Get API Key**

```bash
curl -X GET "{{$ApiURL}}/apikeys:get?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
  "name": "Integration Service",
  "description": "Key for integration",
  "role": "user",
  "can_write": false,
  "key_prefix": "moon_live_ArPaQD...",
  "created_at": "2026-02-02T11:09:07Z",
  "last_used": "2026-02-03T10:15:00Z"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "API key not found",
  "code": 404
}
```

**Create API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false
  }' | jq .
```

**Response (201 Created):**
```json
{
  "message": "API key created successfully",
  "warning": "Store this key securely. It will not be shown again.",
  "apikey": {
    "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false,
    "created_at": "2026-02-02T11:09:07Z"
  },
  "key": "moon_live_ArPaQDdyh4gp9EKF42Xrq7AOAAJZmKiCtTCv1m2rj931QxmPkiXuSV8Un0qllMiN"
}
```

**Response Headers:**
```
HTTP/1.1 201 Created
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 92
X-RateLimit-Reset: 1706875200
```

- In above reposne fields:
  - `id` => `$API_KEY_ID` (e.g: 01KGF0NGEHYKJR8PV5KHQBDHKB)
  - `key` => `$API_KEY` (e.g: moon_live_ArPaQDdyh4gp9EKF42Xrq7AOAAJZmKiCtTCv1m2rj931QxmPkiXuSV8Un0qllMiN).
- Copy and store `key` securely now. It will not be shown again.
- Use this key in the `Authorization: Bearer` header (e.g., `Authorization: Bearer $API_KEY`) for all API requests.

**Update API Key Metadata**

Update metadata such as name, description, or can_write permissions **without** regenerating the key:

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Service Name",
    "description": "Updated description",
    "can_write": true
  }' | jq .
```

**Response (200 OK):**
```json
{
  "message": "API key updated successfully",
  "apikey": {
    "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
    "name": "Updated Service Name",
    "description": "Updated description",
    "role": "user",
    "can_write": true,
    "created_at": "2026-02-02T11:09:07Z",
    "last_used": "2026-02-03T10:15:00Z"
  }
}
```

***Note:*** This operation updates metadata only. The API key itself remains unchanged and valid. To regenerate the key, use the explicit rotation action below.

**Rotate API Key**

To generate a new key and invalidate the old one, use the explicit `action: "rotate"`:

```bash
curl -X POST "{{$ApiURL}}/apikeys:update?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action":"rotate"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "API key rotated successfully",
  "warning": "Old key is now invalid. Store this new key securely.",
  "apikey": {
    "id": "01KGF0NGEHYKJR8PV5KHQBDHKB",
    "name": "Integration Service",
    "description": "Key for integration",
    "role": "user",
    "can_write": false,
    "created_at": "2026-02-02T11:09:07Z"
  },
  "key": "moon_live_NewKeyValueHere12345678901234567890123456789012345678901234"
}
```

**Delete API Key**

```bash
curl -X POST "{{$ApiURL}}/apikeys:destroy?id=$API_KEY_ID" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "message": "API key deleted successfully"
}
```

**Example usage with API key**

```
response=$(curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Service",
    "description": "Key for testing",
    "role": "user",
    "can_write": true
  }')
API_KEY=$(echo $response | jq -r '.key')
```

then you can use it as shown below:

```bash
curl -X GET "http://localhost:6006/collections:list" \
  -H "Authorization: Bearer $API_KEY" | jq .
```

---

## Collection Management

These endpoints manage database tables (collections) and their schemas.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

**List Collections**

```bash
curl -s {{$ApiURL}}/collections:list \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "collections": [
    {
      "name": "products",
      "columns": [
        {"name": "id", "type": "string", "nullable": false},
        {"name": "title", "type": "string", "nullable": false},
        {"name": "price", "type": "string", "nullable": false},
        {"name": "details", "type": "string", "nullable": true},
        {"name": "quantity", "type": "integer", "nullable": false},
        {"name": "brand", "type": "string", "nullable": false},
        {"name": "created_at", "type": "datetime", "nullable": false},
        {"name": "updated_at", "type": "datetime", "nullable": false}
      ]
    },
    {
      "name": "customers",
      "columns": [
        {"name": "id", "type": "string", "nullable": false},
        {"name": "name", "type": "string", "nullable": false},
        {"name": "email", "type": "string", "nullable": false},
        {"name": "created_at", "type": "datetime", "nullable": false},
        {"name": "updated_at", "type": "datetime", "nullable": false}
      ]
    }
  ],
  "total": 2
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 91
X-RateLimit-Reset: 1706875200
```

**Create a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "products",
    "columns": [
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "description", "type": "string", "nullable": true}
    ]
  }' | jq .
```

**Response (201 Created):**
```json
{
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false, "unique": false},
      {"name": "title", "type": "string", "nullable": false, "unique": false},
      {"name": "price", "type": "integer", "nullable": false, "unique": false},
      {"name": "description", "type": "string", "nullable": true, "unique": false},
      {"name": "created_at", "type": "datetime", "nullable": false, "unique": false},
      {"name": "updated_at", "type": "datetime", "nullable": false, "unique": false}
    ]
  },
  "message": "Collection 'products' created successfully"
}
```

**Response Headers:**
```
HTTP/1.1 201 Created
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 90
X-RateLimit-Reset: 1706875200
```

**Error Response (409 Conflict):**
```json
{
  "error": "Collection already exists: products",
  "code": 409
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "Invalid column type: invalid_type",
  "code": 400
}
```

**Get Collection Schema**

```bash
curl -s {{$ApiURL}}/collections:get?name=products \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "name": "products",
  "columns": [
    {"name": "id", "type": "string", "nullable": false},
    {"name": "title", "type": "string", "nullable": false},
    {"name": "price", "type": "integer", "nullable": false},
    {"name": "description", "type": "string", "nullable": true},
    {"name": "created_at", "type": "datetime", "nullable": false},
    {"name": "updated_at", "type": "datetime", "nullable": false}
  ]
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Collection not found: products",
  "code": 404
}
```

**Update a Collection Schema**

Update collection schemas using one or more of the following operations:

- `add_columns` - Add new columns
- `rename_columns` - Rename existing columns
- `modify_columns` - Change column types or attributes
- `remove_columns` - Remove existing columns

Add new columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
      {"name": "stock", "type": "integer", "nullable": false},
			{"name": "category", "type": "string", "nullable": false}
		]
	}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection updated successfully",
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false},
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "description", "type": "string", "nullable": true},
      {"name": "stock", "type": "integer", "nullable": false},
      {"name": "category", "type": "string", "nullable": false},
      {"name": "created_at", "type": "datetime", "nullable": false},
      {"name": "updated_at", "type": "datetime", "nullable": false}
    ]
  }
}
```

Rename existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"rename_columns": [
			{"old_name": "description", "new_name": "details"}
		]
	}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection updated successfully",
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false},
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "details", "type": "string", "nullable": true},
      {"name": "stock", "type": "integer", "nullable": false},
      {"name": "category", "type": "string", "nullable": false},
      {"name": "created_at", "type": "datetime", "nullable": false},
      {"name": "updated_at", "type": "datetime", "nullable": false}
    ]
  }
}
```

Modify existing columns' data types or attributes:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"modify_columns": [
			{"name": "category", "type": "string" , "nullable": true}
		]
	}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection updated successfully",
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false},
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "details", "type": "string", "nullable": true},
      {"name": "stock", "type": "integer", "nullable": false},
      {"name": "category", "type": "string", "nullable": true},
      {"name": "created_at", "type": "datetime", "nullable": false},
      {"name": "updated_at", "type": "datetime", "nullable": false}
    ]
  }
}
```

Remove existing columns:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"remove_columns": ["category"]
	}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection updated successfully",
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false},
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "integer", "nullable": false},
      {"name": "details", "type": "string", "nullable": true},
      {"name": "stock", "type": "integer", "nullable": false},
      {"name": "created_at", "type": "datetime", "nullable": false},
      {"name": "updated_at", "type": "datetime", "nullable": false}
    ]
  }
}
```

Combine multiple operations:

```bash
curl -s -X POST "{{$ApiURL}}/collections:update" \
	-H "Authorization: Bearer $ACCESS_TOKEN" \
	-H "Content-Type: application/json" \
	-d '{
		"name": "products",
		"add_columns": [
			{"name": "brand", "type": "string", "nullable": false}
		],
		"rename_columns": [
			{"old_name": "stock", "new_name": "quantity"}
		],
		"modify_columns": [
			{"name": "price", "type": "string", "nullable": false}
		]
	}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection updated successfully",
  "collection": {
    "name": "products",
    "columns": [
      {"name": "id", "type": "string", "nullable": false},
      {"name": "title", "type": "string", "nullable": false},
      {"name": "price", "type": "string", "nullable": false},
      {"name": "details", "type": "string", "nullable": true},
      {"name": "quantity", "type": "integer", "nullable": false},
      {"name": "brand", "type": "string", "nullable": false},
      {"name": "created_at", "type": "datetime", "nullable": false},
      {"name": "updated_at", "type": "datetime", "nullable": false}
    ]
  }
}
```

**Delete a Collection**

```bash
curl -X POST "{{$ApiURL}}/collections:destroy" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "products"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Collection 'products' destroyed successfully"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Collection not found: products",
  "code": 404
}
```

---

## Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:schema` | GET | Get collection schema (read-only) |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

**List All Records**

```bash
curl -s "{{$ApiURL}}/products:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity": 10,
      "brand": "Wow",
      "created_at": "2026-02-03T10:45:00Z",
      "updated_at": "2026-02-03T10:45:00Z"
    },
    {
      "id": "01KGD5F89ABC0XYZDEF123456G",
      "title": "USB Keyboard",
      "price": "49.99",
      "details": "Mechanical keyboard with RGB",
      "quantity": 5,
      "brand": "TechKeys",
      "created_at": "2026-02-03T11:00:00Z",
      "updated_at": "2026-02-03T11:00:00Z"
    }
  ],
  "total": 2,
  "next_cursor": null,
  "limit": 15
}
```

**Response Headers:**
```
HTTP/1.1 200 OK
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 89
X-RateLimit-Reset: 1706875200
```

**Response (200 OK) - Empty Collection:**
```json
{
  "data": [],
  "total": 0,
  "next_cursor": null,
  "limit": 15
}
```

**Schema Retrieval**

To retrieve the schema for a collection, use the dedicated schema endpoint:

```bash
curl "{{$ApiURL}}/products:schema" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "collection": "products",
  "fields": [
    {"name": "id", "type": "string", "nullable": false},
    {"name": "title", "type": "string", "nullable": false},
    {"name": "price", "type": "string", "nullable": false},
    {"name": "details", "type": "string", "nullable": true},
    {"name": "quantity", "type": "integer", "nullable": false},
    {"name": "brand", "type": "string", "nullable": false},
    {"name": "created_at", "type": "datetime", "nullable": false},
    {"name": "updated_at", "type": "datetime", "nullable": false}
  ],
  "total": 2
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Collection not found: products",
  "code": 404
}
```

**Create a New Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity" : 10,
      "brand": "Wow"
    }
  }' | jq .
```

**Response (201 Created):**
```json
{
  "data": {
    "id": "01KGD5E74RYS0WTNARQC92S1P7",
    "title": "Wireless Mouse",
    "price": "29.99",
    "details": "Ergonomic wireless mouse",
    "quantity": 10,
    "brand": "Wow",
    "created_at": "2026-02-03T10:45:00Z",
    "updated_at": "2026-02-03T10:45:00Z"
  },
  "message": "Record created successfully with id 01KGD5E74RYS0WTNARQC92S1P7"
}
```

**Response Headers:**
```
HTTP/1.1 201 Created
Content-Type: application/json
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 88
X-RateLimit-Reset: 1706875200
```

**Error Response (400 Bad Request):**
```json
{
  "error": "Missing required field: title",
  "code": 400
}
```

**Error Response (422 Unprocessable Entity):**
```json
{
  "error": "Invalid type for field 'quantity': expected integer",
  "code": 422
}
```

**Get a Single Record**

```bash
# First, get the ID from a list or create operation, then:
curl -s "{{$ApiURL}}/products:get?id=<RECORD_ID>" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

***Note:*** Replace `<RECORD_ID>` with an actual record ID from your data (e.g., `01KGD5E74RYS0WTNARQC92S1P7`).

**Response (200 OK):**
```json
{
  "id": "01KGD5E74RYS0WTNARQC92S1P7",
  "title": "Wireless Mouse",
  "price": "29.99",
  "details": "Ergonomic wireless mouse",
  "quantity": 10,
  "brand": "Wow",
  "created_at": "2026-02-03T10:45:00Z",
  "updated_at": "2026-02-03T10:45:00Z"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Record not found",
  "code": 404
}
```

**Update an Existing Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:update" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>","data":{"price":"6000.00"}}' | jq .
```

**Response (200 OK):**
```json
{
  "data": {
    "id": "01KGD5E74RYS0WTNARQC92S1P7",
    "title": "Wireless Mouse",
    "price": "6000.00"
  },
  "message": "Record 01KGD5E74RYS0WTNARQC92S1P7 updated successfully"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Record not found",
  "code": 404
}
```

**Delete a Record**

```bash
curl -s -X POST "{{$ApiURL}}/products:destroy" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"id":"<RECORD_ID>"}' | jq .
```

**Response (200 OK):**
```json
{
  "message": "Record 01KGD5E74RYS0WTNARQC92S1P7 deleted successfully"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Record not found",
  "code": 404
}
```

---

## Query Options

**Filtering:** `?column[operator]=value` 

```bash
curl -g "{{$ApiURL}}/products:list?quantity[gt]=5&brand[eq]=Wow" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity": 10,
      "brand": "Wow",
      "created_at": "2026-02-03T10:45:00Z",
      "updated_at": "2026-02-03T15:30:00Z"
    }
  ],
  "total": 1,
  "next_cursor": null,
  "has_more": false
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "Invalid filter operator: invalid",
  "code": 400
}
```

**Operators:** `eq`, `ne`, `gt`, `lt`, `gte`, `lte`, `like`, `in`

**Sorting:** `?sort={-field1,field2}` 

```bash
curl "{{$ApiURL}}/products:list?sort=-quantity,title" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity": 10,
      "brand": "Wow",
      "created_at": "2026-02-03T10:45:00Z",
      "updated_at": "2026-02-03T15:30:00Z"
    },
    {
      "id": "01KGD5F89ABC0XYZDEF123456G",
      "title": "USB Keyboard",
      "price": "49.99",
      "details": "Mechanical keyboard with RGB",
      "quantity": 5,
      "brand": "TechKeys",
      "created_at": "2026-02-03T11:00:00Z",
      "updated_at": "2026-02-03T11:00:00Z"
    }
  ],
  "total": 2,
  "next_cursor": null,
  "has_more": false
}
```

Sort by `field` (ascending) or `-field` (descending).

**Full-Text Search:** `?q={search_term}` (across all text columns)

```bash
curl "{{$ApiURL}}/products:list?q=mouse" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity": 10,
      "brand": "Wow",
      "created_at": "2026-02-03T10:45:00Z",
      "updated_at": "2026-02-03T15:30:00Z"
    }
  ],
  "total": 1,
  "next_cursor": null,
  "has_more": false
}
```

**Response (200 OK) - No Results:**
```json
{
  "data": [],
  "total": 0,
  "next_cursor": null,
  "has_more": false
}
```

Searches across all string/text fields in the collection.

**Field Selection:** `?fields={field1,field2}`

```bash
curl "{{$ApiURL}}/products:list?fields=quantity,title" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "quantity": 10,
      "title": "Wireless Mouse"
    },
    {
      "id": "01KGD5F89ABC0XYZDEF123456G",
      "quantity": 5,
      "title": "USB Keyboard"
    }
  ],
  "total": 2,
  "next_cursor": null,
  "has_more": false
}
```

Returns only the specified fields (plus `id` which is always included).

**Limit:** `?limit={limit}`

```bash
curl "{{$ApiURL}}/products:list?limit=2" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "data": [
    {
      "id": "01KGD5E74RYS0WTNARQC92S1P7",
      "title": "Wireless Mouse",
      "price": "29.99",
      "details": "Ergonomic wireless mouse",
      "quantity": 10,
      "brand": "Wow",
      "created_at": "2026-02-03T10:45:00Z",
      "updated_at": "2026-02-03T15:30:00Z"
    },
    {
      "id": "01KGD5F89ABC0XYZDEF123456G",
      "title": "USB Keyboard",
      "price": "49.99",
      "details": "Mechanical keyboard with RGB",
      "quantity": 5,
      "brand": "TechKeys",
      "created_at": "2026-02-03T11:00:00Z",
      "updated_at": "2026-02-03T11:00:00Z"
    }
  ],
  "total": 2,
  "next_cursor": "01KGD5F89ABC0XYZDEF123456G",
  "has_more": true
}
```

**Pagination:** `?after={cursor}` (Response includes `next_cursor` when more results are available.)

```bash
curl "{{$ApiURL}}/products:list?after=01ARZ3NDEKTSV4RRFFQ69G5FBX&limit=10" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK) - More Pages Available:**
```json
{
  "data": [
    {
      "id": "01KGD5G12XYZ789GHIJKLMNO34",
      "title": "Monitor Stand",
      "price": "34.99",
      "details": "Adjustable monitor stand",
      "quantity": 15,
      "brand": "Ergo",
      "created_at": "2026-02-03T12:00:00Z",
      "updated_at": "2026-02-03T12:00:00Z"
    }
  ],
  "total": 1,
  "next_cursor": "01KGD5G12XYZ789GHIJKLMNO34",
  "has_more": true
}
```

**Response (200 OK) - Last Page:**
```json
{
  "data": [
    {
      "id": "01KGD5H90PQRST123456VWXYZ",
      "title": "Desk Lamp",
      "price": "24.99",
      "details": "LED desk lamp",
      "quantity": 8,
      "brand": "BrightLight",
      "created_at": "2026-02-03T13:00:00Z",
      "updated_at": "2026-02-03T13:00:00Z"
    }
  ],
  "total": 1,
  "next_cursor": null,
  "has_more": false
}
```

**Combined Query Examples:**

Filter, sort, and limit:
```bash
curl -g "{{$ApiURL}}/products:list?quantity[gte]=10&price[lt]=100&sort=-price&limit=5" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Search with category filter and field selection:
```bash
curl -g "{{$ApiURL}}/products:list?q=laptop&brand[eq]=Wow&fields=title,price,quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Multiple filters with pagination:
```bash
curl -g "{{$ApiURL}}/products:list?price[gte]=100&quantity[gt]=0&sort=-price&limit=10&after=01ARZ3NDEK" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

---

## Aggregation Operations

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |

**Count Records:** `:count`

```bash
curl "{{$ApiURL}}/products:count" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "count": 15
}
```

**Response (200 OK) - With Filters:**
```bash
curl -g "{{$ApiURL}}/products:count?quantity[gt]=10" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

```json
{
  "count": 5
}
```

**Sum Numeric Field:** `:sum?field={field_name}`

```bash
curl "{{$ApiURL}}/products:sum?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "sum": 150
}
```

**Error Response (400 Bad Request):**
```json
{
  "error": "Field 'quantity' is required for sum operation",
  "code": 400
}
```

**Average Numeric Field:** `:avg?field={field_name}`

```bash
curl "{{$ApiURL}}/products:avg?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "avg": "10.5"
}
```

**Minimum Value:** `:min?field={field_name}`

```bash
curl "{{$ApiURL}}/products:min?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "min": 5
}
```

**Maximum Value:** `:max?field={field_name}`

```bash
curl "{{$ApiURL}}/products:max?field=quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

**Response (200 OK):**
```json
{
  "max": 50
}
```

***Note:*** Aggregation functions (sum, avg, min, max) work on both `integer` and `decimal` field types. In the examples above, `price` was changed to `string` type during schema updates, so we use `quantity` for demonstrations. For decimal fields, aggregation results are returned as strings (e.g., `"1234.56"`).

---

## Security

**Rate Limiting**

Every response includes rate limit information in the headers:

- `X-RateLimit-Limit`: Maximum requests allowed in the time window
- `X-RateLimit-Remaining`: Number of requests remaining in current window
- `X-RateLimit-Reset`: Unix timestamp when the rate limit resets

**Example Response Headers:**

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1706875200
```

**Rate Limit Exceeded Response (429):**

When you exceed the rate limit (100/min/user for JWT, 1000/min/key for API Key), you'll receive:

**Response (429 Too Many Requests):**
```json
{
  "error": "Rate limit exceeded. Try again later.",
  "code": 429
}
```

**Response Headers:**
```
HTTP/1.1 429 Too Many Requests
Content-Type: application/json
Retry-After: 60
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1706875260
```

Wait until the time specified in `X-RateLimit-Reset` before retrying, or use the `Retry-After` header value (in seconds).

---

**CORS Configuration**

Moon supports Cross-Origin Resource Sharing (CORS) for browser-based clients with dynamic endpoint registration.

- **Public Endpoints (No Authentication):**
  - `GET /health` - Health check
  - `GET /doc` - API documentation (HTML)
  - `GET /doc/llms-full.txt` - API documentation (Markdown)

- **CORS Headers:**
  ```
  Access-Control-Allow-Origin: *
  Access-Control-Allow-Methods: GET, POST, OPTIONS
  Access-Control-Allow-Headers: Authorization, Content-Type
  Access-Control-Max-Age: 3600
  ```

- **Pattern-Based Configuration:** CORS policies can be configured per endpoint or pattern (exact, prefix, suffix, contains) in the configuration file.
  - Administrators can register additional CORS-enabled endpoints
  - Per-endpoint origin restrictions
  - Authentication bypass for public endpoints
  - See `SPEC.md` for detailed configuration options

- **OPTIONS Preflight:** Check allowed methods/headers for any endpoint:
  ```bash
  curl -s -X OPTIONS "{{$ApiURL}}/collections:list" \
    -H "Origin: http://localhost:3000" \
    -H "Access-Control-Request-Method: GET" | jq .
  ```
  
  **Response (200 OK):**
  ```json
  {
    "allowed_methods": ["GET", "POST", "OPTIONS"],
    "allowed_headers": ["Authorization", "Content-Type"],
    "max_age": 3600
  }
  ```
  
  **Response Headers:**
  ```
  HTTP/1.1 200 OK
  Access-Control-Allow-Origin: http://localhost:3000
  Access-Control-Allow-Methods: GET, POST, OPTIONS
  Access-Control-Allow-Headers: Authorization, Content-Type
  Access-Control-Max-Age: 3600
  ```

- **Credentials:** Supported when origin is explicitly allowed (not `*`).
  - Note: If you need to send cookies or credentials, set a specific allowed origin in your config (not `*`).

---

## JSON Appendix

This machine-readable appendix enables automated client generation and reduces ambiguity for AI coding agents.

```json
{{.JSONAppendix}}
```

{{/* 
  Markdown File Inclusion Example:
  To include markdown files, use: {{ include "filename.md" }}
  
  Example includes available:
  - {{ include "footer.md" }}
  - {{ include "troubleshooting.md" }}
  - {{ include "example.md" }}
  
  See templates/md/README.md for documentation.
*/}}

---
**[Moon](https://github.com/devnodesin/moon)** made by [Devnodes.in](https://devnodes.in)
---