{{- $ApiURL := .BaseURL -}}
{{- if .Prefix }}{{- $ApiURL = printf "%s%s" .BaseURL .Prefix -}}{{- end -}}

# Moon – Instructions and API Documentation for AI Coding Agents

> **Quick Start:**
> 1. [View HTML docs]({{$ApiURL}}/doc/) or [Markdown docs]({{$ApiURL}}/doc/llms-full.txt)
> 2. [Authenticate](#authentication) (see below)
> 3. [Try a sample request](#collection-management)
> 4. [See JSON Appendix](#json-appendix) for machine-readable spec
> 5. For help or to report issues, visit [GitHub Issues](https://github.com/devnodesin/moon/issues)

| Property    | Value                                               |
|-------------|-----------------------------------------------------|
| Version     | {{.Version}}                                        |
| Service     | moon                                                |
| Base URL    | `{{.BaseURL}}`                                      |
| URL Prefix  | {{if .Prefix}}`{{.Prefix}}`{{else}}N/A{{end}}       |
| Documentation Version     | 1.5.1                                 |
| Github URL  | https://github.com/devnodesin/moon                      |

{{if .Prefix}} All endpoints are prefixed with `{{.Prefix}}`. {{end}}


## Table of Contents

- [Intro](#intro)
- [Public Endpoints](#public-endpoints)
- [Authentication](#authentication)
- [Response Format](#response-format)
- [Auth Endpoints](#auth-endpoints)
- [User Management Endpoints (Admin Only)](#user-management-endpoints-admin-only)
- [API Key Management Endpoints (Admin Only)](#api-key-management-endpoints-admin-only)
- [Collection Management](#collection-management)
- [Data Access](#data-access)
- [Query Options](#query-options)
- [Aggregation Operations](#aggregation-operations)
- [Security](#security)
- [JSON Appendix](#json-appendix)

## Intro

Moon enables rapid, migrationless management of database tables and records through a dynamic RESTful API.

**Moon Terminology**

Moon stores data in the format: Collection, Field, and Record.

In database terminology, these are Tables, Columns, and Rows, respectively.

For example, consider the table `products` below.

```md
| id        | name           | price   | in_stock |
|-----------|----------------|---------|----------|
| 01H1...   | Wireless Mouse | 29.99   | true     |
| 01H2...   | USB Keyboard   | 19.99   | false    |
```

- **Collection:** `products` (the table)
- **Field:** `id`, `name`, `price`, `in_stock` (the columns)
- **Record:** Each row, e.g., `{ "id": "01H1...", "name": "Wireless Mouse", "price": "29.99", "in_stock": true }`


**What Moon Does NOT Do**

Moon is intentionally minimal. It does **not** support:

- **Transactions:** No multi-statement atomicity; each request is independent.
- **Joins:** No SQL joins; model relationships in your application.
- **Triggers/Hooks:** No database-level triggers or event hooks.
- **Background Jobs:** No built-in job queue or async processing.
- **Foreign Keys:** Relations must be managed manually.
- **Migrations/Schema Versioning:** No built-in migration or schema versioning system.
- **Backup/Restore:** No built-in backup or restore; handle externally.
- **Fine-grained ACLs:** Only `user` and `admin` roles; no per-collection/field ACL.
- **WebSocket/Realtime:** No realtime or WebSocket support.
- **File/Binary Storage:** No file uploads or binary/blob storage.
- **Scheduled Tasks:** No cron or scheduled task support.
- **Encryption at Rest:** No built-in data encryption at rest.
- **Admin UI:** API-only; no built-in web UI or dashboard.
- **HTTP Methods:** Only supports `GET`, `POST`, and `OPTIONS` (no `PUT`, `PATCH`, or `DELETE`).
- **Public endpoints:** `/health`, `/doc`, `/doc/llms-full.txt`.

**Design Constraints**

- Collection names: lowercase, snake_case.
- Field names: unique per collection.
- No joins; handle relations at the application layer.


**Rules: Do's**

- Moon is schema-on-demand.
- Always check or create collections before inserting data.
- Use API keys for server-side apps; JWT for user-facing auth.
- Endpoints follow AIP-136 custom actions (colon separator).
- Rate limits: JWT 100/min/user, API Key 1,000/min/key.
- User roles: `user` (limited), `admin` (full).
- Input validation: types and constraints enforced; always sanitize input.
- **Always use HTTPS in production.** (All curl examples assume HTTPS for production use.)
- Set explicit allowed origins for CORS.

**Rules: Don'ts**

- Don’t use joins, transactions, triggers, or background jobs—handle these in your app.
- Don’t assume foreign keys; manage relations manually.

**Data Types**

Supported column data types:

- `string` - Text values of any length (maps to TEXT in SQL)
- `integer` - 64-bit whole numbers
- `decimal` - For decimal values. API input/output uses strings (e.g., `"199.99"`), with a default of 2 decimal places.
- `boolean` - true/false values
- `datetime` - Date/time in RFC3339 or ISO 8601 format (e.g., 2023-01-31T13:45:00Z)
- `json` - Arbitrary JSON object or array

***Note:*** Aggregation functions (sum, avg, min, max) are supported on both `integer` and `decimal` field types.

---

## Public Endpoints

{{ include "010-health.md" }}

{{ include "011-doc.md" }}
---

## Authentication 

{{if or .JWTEnabled .APIKeyEnabled}}All requests to protected endpoints require authentication via the `Authorization` header:

```
Authorization: Bearer <TOKEN>
```

### JWT Token Example

JWT tokens are obtained from `POST /auth:login` and are used for interactive users:

```bash
# Login and save tokens to environment variables
response=$(curl -s -X POST "{{$ApiURL}}/auth:login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"moonadmin12#"}')
ACCESS_TOKEN=$(echo $response | jq -r '.access_token')
REFRESH_TOKEN=$(echo $response | jq -r '.refresh_token')

# Use in subsequent requests
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

{{if .APIKeyEnabled}}### API Key Example

API keys are obtained from `POST /apikeys:create` and are used for service integrations:

```bash
# Create an API key (requires admin role)
curl -X POST "{{$ApiURL}}/apikeys:create" \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"My Service Key","role":"user"}' | jq .

# Use the API key in requests (same Authorization header format)
curl -s "{{$ApiURL}}/collections:list" \
  -H "Authorization: Bearer moon_live_abc123..." | jq .
```

{{end}}**Token Types:**
- **JWT tokens** (`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`) - for interactive users
{{if .APIKeyEnabled}}- **API keys** (`moon_live_<64_chars>`) - for service integrations{{end}}
- Both use the same `Authorization: Bearer` header format

{{else}}Authentication is currently disabled for this instance.

{{- end}}

---

## Response Format

All successful responses return JSON with relevant data.

| Status Code | Meaning |
|-------------|---------|
| `200 OK`      | Successful GET requests                                        |
| `201 Created` | Successful POST requests creating resources                    |
| `400 Bad Request` | Invalid input, missing required field, invalid filter operator |
| `404 Not Found`   | Collection/record not found                             |
| `409 Conflict`    | Collection/record already exists                                  |
| `500 Internal Server Error` | Server error                                     |

### Success Responses (200 or 201)

```json
{
  "message": "Collection created successfully",
  "collection": {
    "name": "products",
    "columns": [...]
  }
}
```

### Error Responses

All errors follow a consistent JSON structure:

```json
{
  "error": "Error message describing what went wrong",
  "code": {HTTP status error code}
}
```

---

## Auth Endpoints

| Endpoint       | Method | Description                                 |
|----------------|--------|---------------------------------------------|
| /auth:login    | POST   | Authenticate user, receive tokens           |
| /auth:logout   | POST   | Invalidate current session's refresh token  |
| /auth:refresh  | POST   | Exchange refresh token for new tokens       |
| /auth:me       | GET    | Get current authenticated user info         |
| /auth:me       | POST   | Update current user's profile/password      |

{{ include "020-auth.md" }}

---

## User Management Endpoints (Admin Only)

| Endpoint        | Method | Description                              |
|-----------------|--------|------------------------------------------|
| /users:list     | GET    | List all users                           |
| /users:get      | GET    | Get specific user by ID                  |
| /users:create   | POST   | Create new user                          |
| /users:update   | POST   | Update user properties or admin actions  |
| /users:destroy  | POST   | Delete user account                      |

{{ include "030-users.md" }}

---

## API Key Management Endpoints (Admin Only)

| Endpoint         | Method | Description                                 |
|------------------|--------|---------------------------------------------|
| /apikeys:list    | GET    | List all API keys                           |
| /apikeys:get     | GET    | Get specific API key                        |
| /apikeys:create  | POST   | Create new API key                          |
| /apikeys:update  | POST   | Update API key metadata or rotate key       |
| /apikeys:destroy | POST   | Delete API key                              |

{{ include "040-apikeys.md" }}

---

## Collection Management

These endpoints manage database tables (collections) and their schemas.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/collections:list` | GET | List all collections |
| `{{.Prefix}}/collections:get` | GET | Get collection schema (requires `?name=...`) |
| `{{.Prefix}}/collections:create` | POST | Create a new collection |
| `{{.Prefix}}/collections:update` | POST | Update collection schema |
| `{{.Prefix}}/collections:destroy` | POST | Delete a collection |

Update collection support following schema modification operations:

- `add_columns` - Add new columns
- `rename_columns` - Rename existing columns
- `modify_columns` - Change column types or attributes
- `remove_columns` - Remove existing columns


{{ include "050-collection.md" }}

---

## Data Access

These endpoints manage records within a specific collection. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:list` | GET | List all records |
| `{{.Prefix}}/{collection}:schema` | GET | Get collection schema (read-only) |
| `{{.Prefix}}/{collection}:get` | GET | Get a single record (requires `?id=...`) |
| `{{.Prefix}}/{collection}:create` | POST | Create a new record |
| `{{.Prefix}}/{collection}:update` | POST | Update an existing record |
| `{{.Prefix}}/{collection}:destroy` | POST | Delete a record |

{{ include "060-data.md" }}

---

## Query Options

Query parameters for filtering, sorting, searching, field selection, and pagination when listing records. Using these options allows you to retrieve specific subsets of data based on your criteria.

| Query Options | Description |
|---------------|-------------|
| `?column[operator]=value` | Filter records by column values using comparison operators |
| `?sort={fields}` | Sort by one or more fields (prefix `-` for descending) |
| `?q={term}` | Full-text search across all text columns |
| `?fields={field1,field2}` | Select specific fields to return (id always included) |
| `?limit={number}` | Limit number of records returned (default: 15, max: 100) |
| `?after={cursor}` | Get records after the specified cursor |

{{ include "070-query.md" }}

### Combined Query Examples

query parameters can be combined to perform complex queries. Here are some examples:

Filter, sort, and limit:
```bash
curl -g "{{$ApiURL}}/products:list?quantity[gte]=10&price[lt]=100&sort=-price&limit=5" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Search with category filter and field selection:
```bash
curl -g "{{$ApiURL}}/products:list?q=laptop&brand[eq]=Wow&fields=title,price,quantity" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Multiple filters with pagination:
```bash
curl -g "{{$ApiURL}}/products:list?price[gte]=100&quantity[gt]=0&sort=-price&limit=10&after=01ARZ3NDEK" \
  -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

---

## Aggregation Operations

Traditional analytics and reporting often require downloading large datasets to the client for processing, which is inefficient and slow—especially for counting, summing, or calculating averages across millions of records.

Moon provides dedicated aggregation endpoints that perform calculations directly on the server. This enables fast, efficient analytics—such as counting records, summing numeric fields, computing averages, and finding minimum or maximum values—without transferring unnecessary data.

Server-side aggregation endpoints for analytics. Replace `{collection}` with your collection name.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `{{.Prefix}}/{collection}:count` | GET | Count records |
| `{{.Prefix}}/{collection}:sum` | GET | Sum numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:avg` | GET | Average numeric field (requires `?field=...`) |
| `{{.Prefix}}/{collection}:min` | GET | Minimum value (requires `?field=...`) |
| `{{.Prefix}}/{collection}:max` | GET | Maximum value (requires `?field=...`) |

***Note:***

- Aggregation can be combined with filters (e.g., `?quantity[gt]=10`) to perform calculations on specific subsets of data.
- Aggregation functions (`sum`, `avg`, `min`, `max`) are supported only on `integer` and `decimal` field types. 

{{ include "080-aggregation.md" }}

---

## Security

{{ include "091-security.md" }}

---

## JSON Appendix

This machine-readable appendix enables automated client generation and reduces ambiguity for AI coding agents.

```json
{{.JSONAppendix}}
```

---

**[Moon](https://github.com/devnodesin/moon)** made by [Devnodes.in](https://devnodes.in)

---
